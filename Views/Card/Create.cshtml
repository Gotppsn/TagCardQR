@model CardTagManager.Models.Card

@{
    ViewData["Title"] = "Create New Product";
}

<div class="mb-6">
    <a href="#" class="inline-flex items-center text-primary-600 hover:text-primary-700 transition-colors group">
        <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i> Back to Library
    </a>
</div>

<!-- Form Progress Indicator -->
<div class="form-progress mb-6">
    <div class="flex items-center justify-between max-w-2xl mx-auto">
        <div class="step active" data-step="1">
            <div class="step-circle bg-primary-600 text-white h-8 w-8 rounded-full flex items-center justify-center">1</div>
            <div class="step-label text-sm font-medium mt-1">Basic Info</div>
        </div>
        <div class="step-connector h-1 flex-grow bg-gray-200 mx-2 relative">
            <div class="absolute inset-0 bg-primary-600 step-progress" style="width: 0%"></div>
        </div>
        <div class="step" data-step="2">
            <div class="step-circle bg-gray-200 text-gray-600 h-8 w-8 rounded-full flex items-center justify-center">2</div>
            <div class="step-label text-sm font-medium mt-1">Details</div>
        </div>
        <div class="step-connector h-1 flex-grow bg-gray-200 mx-2 relative">
            <div class="absolute inset-0 bg-primary-600 step-progress" style="width: 0%"></div>
        </div>
        <div class="step" data-step="3">
            <div class="step-circle bg-gray-200 text-gray-600 h-8 w-8 rounded-full flex items-center justify-center">3</div>
            <div class="step-label text-sm font-medium mt-1">Appearance</div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-5 gap-8 fade-in">
    <!-- Form Section (3 columns) -->
    <div class="lg:col-span-3">
        <div class="card">
            <div class="card-header">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-plus-circle text-primary-500 mr-2"></i> Add New Product
                </h2>
                <p class="text-sm text-gray-500 mt-1">Fill in the details for your product tag</p>
            </div>
            
            <!-- Template Gallery -->
            <div class="px-6 pt-4 pb-2 border-b border-gray-100">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Quick Start Templates</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="template-card cursor-pointer border rounded-lg p-2 hover:border-primary-500 transition-all" data-template="chemical">
                        <div class="aspect-w-16 aspect-h-10 bg-blue-50 rounded mb-2 p-2 flex items-center justify-center">
                            <i class="fas fa-flask text-blue-500 text-xl"></i>
                        </div>
                        <p class="text-xs text-center">Chemical Product</p>
                    </div>
                    <div class="template-card cursor-pointer border rounded-lg p-2 hover:border-primary-500 transition-all" data-template="equipment">
                        <div class="aspect-w-16 aspect-h-10 bg-purple-50 rounded mb-2 p-2 flex items-center justify-center">
                            <i class="fas fa-tools text-purple-500 text-xl"></i>
                        </div>
                        <p class="text-xs text-center">Equipment</p>
                    </div>
                    <div class="template-card cursor-pointer border rounded-lg p-2 hover:border-primary-500 transition-all" data-template="safety">
                        <div class="aspect-w-16 aspect-h-10 bg-orange-50 rounded mb-2 p-2 flex items-center justify-center">
                            <i class="fas fa-hard-hat text-orange-500 text-xl"></i>
                        </div>
                        <p class="text-xs text-center">Safety Equipment</p>
                    </div>
                    <div class="template-card cursor-pointer border rounded-lg p-2 hover:border-primary-500 transition-all" data-template="office">
                        <div class="aspect-w-16 aspect-h-10 bg-green-50 rounded mb-2 p-2 flex items-center justify-center">
                            <i class="fas fa-desktop text-green-500 text-xl"></i>
                        </div>
                        <p class="text-xs text-center">Office Equipment</p>
                    </div>
                </div>
                
                <!-- Advanced Template Picker (Hidden by default) -->
                <div class="hidden mt-4 pt-4 border-t border-gray-100" id="advanced-templates">
                    <h4 class="text-xs font-medium text-gray-600 mb-2">Industry-Specific Templates</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="template-card cursor-pointer border rounded-lg p-2 hover:border-primary-500 transition-all" data-template="laboratory">
                            <div class="aspect-w-16 aspect-h-10 bg-indigo-50 rounded mb-2 p-2 flex items-center justify-center">
                                <i class="fas fa-vial text-indigo-500 text-xl"></i>
                            </div>
                            <p class="text-xs text-center">Laboratory</p>
                        </div>
                        <div class="template-card cursor-pointer border rounded-lg p-2 hover:border-primary-500 transition-all" data-template="maintenance">
                            <div class="aspect-w-16 aspect-h-10 bg-yellow-50 rounded mb-2 p-2 flex items-center justify-center">
                                <i class="fas fa-wrench text-yellow-500 text-xl"></i>
                            </div>
                            <p class="text-xs text-center">Maintenance</p>
                        </div>
                        <div class="template-card cursor-pointer border rounded-lg p-2 hover:border-primary-500 transition-all" data-template="it">
                            <div class="aspect-w-16 aspect-h-10 bg-cyan-50 rounded mb-2 p-2 flex items-center justify-center">
                                <i class="fas fa-microchip text-cyan-500 text-xl"></i>
                            </div>
                            <p class="text-xs text-center">IT Asset</p>
                        </div>
                        <div class="template-card cursor-pointer border rounded-lg p-2 hover:border-primary-500 transition-all" data-template="custom">
                            <div class="aspect-w-16 aspect-h-10 bg-gray-50 rounded mb-2 p-2 flex items-center justify-center">
                                <i class="fas fa-plus text-gray-500 text-xl"></i>
                            </div>
                            <p class="text-xs text-center">Custom Template</p>
                        </div>
                    </div>
                </div>
                
                <button type="button" id="show-more-templates" class="text-xs text-primary-600 hover:text-primary-700 mt-3 flex items-center">
                    <i class="fas fa-chevron-down mr-1"></i> Show more templates
                </button>
                <button type="button" id="hide-more-templates" class="text-xs text-primary-600 hover:text-primary-700 mt-3 hidden flex items-center">
                    <i class="fas fa-chevron-up mr-1"></i> Hide additional templates
                </button>
            </div>
            
            <form id="product-form" enctype="multipart/form-data">
                <!-- Add hidden fields for QR colors -->
                <input type="hidden" name="QrFgColor" id="qrFgColorHidden" value="#000000" />
                <input type="hidden" name="QrBgColor" id="qrBgColorHidden" value="#FFFFFF" />
                <div class="card-body">
                    <!-- Step 1: Basic Information -->
                    <div class="form-section" data-step="1">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b">
                            <h3 class="text-md font-semibold text-gray-700">Basic Information</h3>
                            <button type="button" id="add-custom-field" class="text-xs flex items-center text-primary-600 hover:text-primary-700 transition-colors">
                                <i class="fas fa-plus-circle mr-1"></i> Add Custom Field
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="form-group">
                                    <label for="ProductName" class="form-label flex items-center">
                                        Product Name
                                        <span class="text-red-500 ml-1">*</span>
                                        <span class="ml-auto text-xs text-gray-400" id="name-counter">0/100</span>
                                    </label>
                                    <div class="relative">
                                        <input id="ProductName" name="ProductName" class="form-input pl-9" required 
                                               placeholder="RustShield Pro 5000" maxlength="100"
                                               oninput="countChars(this, 'name-counter', 100)">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-tag text-gray-400"></i>
                                        </div>
                                        <div class="validation-icon absolute inset-y-0 right-3 flex items-center hidden" id="name-valid">
                                            <i class="fas fa-check-circle text-green-500"></i>
                                        </div>
                                    </div>
                                    <span class="form-error"></span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="Category" class="form-label">
                                        Category
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">
                                        <select id="Category" name="Category" class="form-input pl-9">
                                            <option value="Rust Coating Chemical">Rust Coating Chemical</option>
                                            <option value="Application Equipment">Application Equipment</option>
                                            <option value="Lab Equipment">Lab Equipment</option>
                                            <option value="Office Equipment">Office Equipment</option>
                                            <option value="Safety Equipment">Safety Equipment</option>
                                            <option value="Quality Control">Quality Control</option>
                                            <option value="Other">Other</option>
                                        </select>
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-folder text-gray-400"></i>
                                        </div>
                                    </div>
                                    <span class="form-error"></span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="Manufacturer" class="form-label">
                                        Manufacturer
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">
                                        <input id="Manufacturer" name="Manufacturer" class="form-input pl-9" required placeholder="ChemTech Industries">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-industry text-gray-400"></i>
                                        </div>
                                    </div>
                                    <span class="form-error"></span>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="form-group">
                                    <label for="ModelNumber" class="form-label">
                                        Model Number
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">
                                        <input id="ModelNumber" name="ModelNumber" class="form-input pl-9" required placeholder="RS-5000-X">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-barcode text-gray-400"></i>
                                        </div>
                                    </div>
                                    <span class="form-error"></span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="SerialNumber" class="form-label">
                                        Serial Number
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">
                                        <input id="SerialNumber" name="SerialNumber" class="form-input pl-9" required placeholder="CT20250001">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-fingerprint text-gray-400"></i>
                                        </div>
                                    </div>
                                    <span class="form-error"></span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Product Image</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors cursor-pointer" id="dropzone">
                                        <input type="file" class="hidden" id="product-image" name="ImageFile" accept="image/*">
                                        <div class="flex flex-col items-center justify-center">
                                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                                            <p class="text-sm text-gray-500 mb-1">Drag and drop an image here or click to browse</p>
                                            <p class="text-xs text-gray-400">PNG, JPG up to 5MB</p>
                                        </div>
                                    </div>
                                    <div id="image-preview" class="hidden mt-2">
                                        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-2">
                                            <div class="flex items-center">
                                                <img src="" alt="Preview" class="w-10 h-10 object-cover rounded mr-2">
                                                <span class="text-sm text-gray-700 filename">filename.jpg</span>
                                            </div>
                                            <button type="button" class="text-red-500 hover:text-red-700" id="remove-image">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Fields Container -->
                        <div id="custom-fields-container" class="mt-6 border-t border-gray-100 pt-4">
                            <h4 class="text-sm font-medium text-gray-600 mb-3">Custom Fields</h4>
                            
                            <!-- Custom fields will be added here dynamically -->
                            <div class="custom-fields-list space-y-4">
                                <!-- Example custom field (will be cloned or replaced by JS) -->
                                <div class="custom-field-item hidden" id="custom-field-template">
                                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                        <div class="flex justify-between mb-2">
                                            <div class="flex items-center">
                                                <i class="fas fa-grip-lines mr-2 text-gray-400 cursor-move"></i>
                                                <h5 class="text-sm font-medium custom-field-label">Custom Field</h5>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <button type="button" class="text-gray-500 hover:text-gray-700 edit-custom-field">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </button>
                                                <button type="button" class="text-red-500 hover:text-red-700 remove-custom-field">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="relative">
                                            <input type="text" class="form-input custom-field-input" name="custom_fields[0][value]" placeholder="Enter value">
                                            <input type="hidden" class="custom-field-key" name="custom_fields[0][key]" value="">
                                            <input type="hidden" class="custom-field-type" name="custom_fields[0][type]" value="text">
                                            <input type="hidden" class="custom-field-icon" name="custom_fields[0][icon]" value="fa-star">
                                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 flex items-center justify-center custom-field-icon-display text-gray-400">
                                                <i class="fas fa-star"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Empty state for custom fields -->
                            <div id="custom-fields-empty" class="bg-gray-50 border border-gray-200 border-dashed rounded-lg p-6 text-center">
                                <div class="text-gray-400 mb-2">
                                    <i class="fas fa-plus-circle text-2xl"></i>
                                </div>
                                <p class="text-sm text-gray-500">No custom fields added yet</p>
                                <p class="text-xs text-gray-400 mt-1">Add custom fields to include additional product information</p>
                                <button type="button" class="mt-3 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs rounded-md" id="add-first-custom-field">
                                    <i class="fas fa-plus mr-1"></i> Add Custom Field
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button type="button" class="btn-primary next-step" data-next="2">
                                Continue to Details <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Product Details -->
                    <div class="form-section hidden" data-step="2">
                        <h3 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b">Product Details</h3>
                        
                        <div class="space-y-4">
                            <div class="form-group">
                                <label for="Location" class="form-label">Location</label>
                                <div class="relative">
                                    <input id="Location" name="Location" class="form-input pl-9" placeholder="Chemical Storage Room A">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-map-marker-alt text-gray-400"></i>
                                    </div>
                                </div>
                                <span class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label for="MaintenanceInfo" class="form-label">Maintenance Information</label>
                                <div class="relative">
                                    <textarea id="MaintenanceInfo" name="MaintenanceInfo" class="form-input h-20 pl-9" 
                                              placeholder="Store at 10-15Â°C, away from direct sunlight"></textarea>
                                    <div class="absolute top-3 left-0 pl-3 flex items-start pointer-events-none">
                                        <i class="fas fa-wrench text-gray-400"></i>
                                    </div>
                                </div>
                                <span class="form-error"></span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="form-group">
                                <label for="ManufactureDate" class="form-label">
                                    Manufacture Date
                                    <span class="text-red-500 ml-1">*</span>
                                </label>
                                <div class="relative">
                                    <input id="ManufactureDate" name="ManufactureDate" type="date" class="form-input pl-9" required>
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-calendar-day text-gray-400"></i>
                                    </div>
                                </div>
                                <span class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label for="PurchaseDate" class="form-label">
                                    Purchase Date
                                    <span class="text-red-500 ml-1">*</span>
                                </label>
                                <div class="relative">
                                    <input id="PurchaseDate" name="PurchaseDate" type="date" class="form-input pl-9" required>
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-shopping-cart text-gray-400"></i>
                                    </div>
                                </div>
                                <span class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label for="WarrantyExpiration" class="form-label">
                                    Warranty Until
                                    <span class="text-red-500 ml-1">*</span>
                                </label>
                                <div class="relative">
                                    <input id="WarrantyExpiration" name="WarrantyExpiration" type="date" class="form-input pl-9" required>
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-shield-alt text-gray-400"></i>
                                    </div>
                                </div>
                                <span class="form-error"></span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button type="button" class="btn-secondary prev-step" data-prev="1">
                                <i class="fas fa-arrow-left mr-2"></i> Back to Basic Info
                            </button>
                            <button type="button" class="btn-primary next-step" data-next="3">
                                Continue to Appearance <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Appearance -->
                    <div class="form-section hidden" data-step="3">
                        <h3 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b">Card Appearance</h3>
                        
                        <div class="mb-6">
                            <label class="form-label">Card Layout</label>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="layout-option border rounded-lg p-2 cursor-pointer hover:border-primary-500 transition-colors active" data-layout="standard">
                                    <input type="hidden" name="Layout" id="layoutHidden" value="standard" />
                                    <div class="bg-gray-100 rounded mb-1 flex items-center justify-center p-3">
                                        <div class="w-full aspect-w-16 aspect-h-10 bg-white rounded shadow-sm p-1">
                                            <div class="flex">
                                                <div class="flex-grow">
                                                    <div class="w-1/2 h-2 bg-gray-300 rounded mb-1"></div>
                                                    <div class="w-3/4 h-1 bg-gray-300 rounded mb-2"></div>
                                                    <div class="space-y-1">
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                    </div>
                                                </div>
                                                <div class="w-1/4 flex items-center justify-center">
                                                    <div class="w-10 h-10 bg-gray-300 rounded"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-center">Standard</p>
                                </div>
                                <div class="layout-option border rounded-lg p-2 cursor-pointer hover:border-primary-500 transition-colors" data-layout="modern">
                                    <div class="bg-gray-100 rounded mb-1 flex items-center justify-center p-3">
                                        <div class="w-full aspect-w-16 aspect-h-10 bg-white rounded shadow-sm p-1">
                                            <div class="flex flex-col">
                                                <div class="h-1/3 w-full bg-gray-300 rounded-t"></div>
                                                <div class="p-1 flex">
                                                    <div class="flex-grow">
                                                        <div class="w-1/2 h-1 bg-gray-300 rounded mb-1"></div>
                                                        <div class="space-y-1">
                                                            <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                            <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                        </div>
                                                    </div>
                                                    <div class="w-1/4 flex items-center justify-center">
                                                        <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-center">Modern</p>
                                </div>
                                <div class="layout-option border rounded-lg p-2 cursor-pointer hover:border-primary-500 transition-colors" data-layout="compact">
                                    <div class="bg-gray-100 rounded mb-1 flex items-center justify-center p-3">
                                        <div class="w-full aspect-w-16 aspect-h-10 bg-white rounded shadow-sm p-1">
                                            <div class="flex">
                                                <div class="flex-grow p-1">
                                                    <div class="w-3/4 h-2 bg-gray-300 rounded mb-1"></div>
                                                    <div class="space-y-1 mt-1">
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                    </div>
                                                </div>
                                                <div class="w-1/3 bg-gray-200 rounded-r flex items-center justify-center">
                                                    <div class="w-8 h-8 bg-gray-300 rounded"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-center">Compact</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="form-group">
                                <label for="BackgroundColor" class="form-label">Background Color</label>
                                <div class="color-picker-wrapper">
                                <div class="flex">
                                    <input type="color" class="color-input hidden" id="bg-color-picker">
                                    <div class="color-preview w-10 h-10 border border-gray-300 rounded-lg shadow-inner cursor-pointer" id="bg-color-preview" style="background-color: #ffffff"></div>
                                    <input id="BackgroundColor" name="BackgroundColor" type="text" class="form-input ml-2 flex-grow" placeholder="#ffffff" value="#ffffff">
                                </div>
                                    <div class="color-presets mt-2 flex flex-wrap gap-2">
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#ffffff" style="background-color: #ffffff;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#f8fafc" style="background-color: #f8fafc;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#f0f9ff" style="background-color: #f0f9ff;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#1e293b" style="background-color: #1e293b;"></span>
                                    </div>
                                </div>
                                <span class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label for="TextColor" class="form-label">Text Color</label>
                                <div class="color-picker-wrapper">
                                    <div class="flex">
                                        <input type="color" class="color-input w-10 h-10 border border-gray-300 rounded-lg shadow-inner cursor-pointer" id="text-color-picker" value="#000000">
                                        <input id="TextColor" name="TextColor" type="text" class="form-input ml-2 flex-grow" placeholder="#000000" value="#000000">
                                    </div>
                                    <div class="color-presets mt-2 flex flex-wrap gap-2">
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#000000" style="background-color: #000000;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#1e293b" style="background-color: #1e293b;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#ffffff" style="background-color: #ffffff;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#64748b" style="background-color: #64748b;"></span>
                                    </div>
                                </div>
                                <span class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label for="AccentColor" class="form-label">Accent Color</label>
                                <div class="color-picker-wrapper">
                                    <div class="flex">
                                        <input type="color" class="color-input w-10 h-10 border border-gray-300 rounded-lg shadow-inner cursor-pointer" id="accent-color-picker" value="#0284c7">
                                        <input id="AccentColor" name="AccentColor" type="text" class="form-input ml-2 flex-grow" placeholder="#0284c7" value="#0284c7">
                                    </div>
                                    <div class="color-presets mt-2 flex flex-wrap gap-2">
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#0284c7" style="background-color: #0284c7;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#f97316" style="background-color: #f97316;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#16a34a" style="background-color: #16a34a;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#9333ea" style="background-color: #9333ea;"></span>
                                    </div>
                                </div>
                                <span class="form-error"></span>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="text-sm font-medium mb-3">QR Code Options</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1">Foreground Color</label>
                                    <div class="flex">
                                        <input type="color" class="w-10 h-10 border border-gray-300 rounded-lg cursor-pointer" value="#000000" id="qr-fg-color">
                                        <input type="text" class="form-input ml-2 flex-grow text-sm" value="#000000" id="qr-fg-color-text">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1">Background Color</label>
                                    <div class="flex">
                                        <input type="color" class="w-10 h-10 border border-gray-300 rounded-lg cursor-pointer" value="#ffffff" id="qr-bg-color">
                                        <input type="text" class="form-input ml-2 flex-grow text-sm" value="#ffffff" id="qr-bg-color-text">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button type="button" class="btn-secondary prev-step" data-prev="2">
                                <i class="fas fa-arrow-left mr-2"></i> Back to Details
                            </button>
                            <button type="submit" class="btn-primary relative group">
                                <span class="flex items-center">
                                    <i class="fas fa-save mr-2"></i> Create Product
                                </span>
                                <span class="absolute inset-0 flex items-center justify-center bg-primary-600 rounded-md opacity-0 transition-opacity group-hover:opacity-0 group-active:opacity-100">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <span class="text-red-500">*</span> Required fields
                        </div>
                        <div class="text-sm text-gray-500">
                            <span class="step-indicator">Step 1 of 3</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Preview Section (2 columns) -->
    <div class="lg:col-span-2">
        <div class="sticky top-6 space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-eye text-primary-500 mr-2"></i> Tag Preview
                </h3>
                <div class="preview-controls flex gap-2">
                    <button type="button" class="text-sm text-gray-600 hover:text-gray-800 flex items-center p-1 hover:bg-gray-100 rounded transition-colors" id="rotate-preview">
                        <i class="fas fa-sync-alt mr-1"></i> Rotate
                    </button>
                    <button type="button" class="text-sm text-gray-600 hover:text-gray-800 flex items-center p-1 hover:bg-gray-100 rounded transition-colors" id="zoom-preview">
                        <i class="fas fa-search-plus mr-1"></i> Zoom
                    </button>
                </div>
            </div>
            
            <div class="card shadow-lg transition-all duration-300" id="card-preview-container">
                <div class="business-card" id="tag-preview" style="background-color: #ffffff; color: #000000">
                    <div class="p-6 h-full flex flex-col">
                        <div class="mb-4">
                            <span id="preview-category" class="px-2 py-1 text-xs font-semibold rounded-full" style="background-color: #0284c7; color: #ffffff">
                                Product Category
                            </span>
                            <h3 id="preview-name" class="text-xl font-bold mt-2" style="color: #0284c7">Product Name</h3>
                            <p id="preview-manufacturer" class="text-md">Manufacturer</p>
                            <div class="flex items-center space-x-2 mt-1 text-sm">
                                <span class="font-semibold">Model:</span>
                                <span id="preview-model">MODEL-XXX</span>
                            </div>
                            <div class="flex items-center space-x-2 text-sm">
                                <span class="font-semibold">Serial:</span>
                                <span id="preview-serial">SN12345</span>
                            </div>
                        </div>
                        <div class="space-y-2 mt-2 text-sm">
                            <p class="flex items-center">
                                <i class="fas fa-map-marker-alt mr-3" style="color: #0284c7"></i>
                                <span class="font-medium">Location:</span>&nbsp;<span id="preview-location">Storage Location</span>
                            </p>
                            <p class="flex items-center">
                                <i class="fas fa-calendar-day mr-3" style="color: #0284c7"></i>
                                <span class="font-medium">Manufactured:</span>&nbsp;<span id="preview-mfgdate">Jan 1, 2025</span>
                            </p>
                            <p class="flex items-center">
                                <i class="fas fa-calendar-check mr-3" style="color: #0284c7"></i>
                                <span class="font-medium">Warranty Until:</span>&nbsp;<span id="preview-warranty">Jan 1, 2026</span>
                            </p>
                            <p class="flex items-center">
                                <i class="fas fa-tools mr-3" style="color: #0284c7"></i>
                                <span class="font-medium">Maintenance:</span>&nbsp;<span id="preview-maintenance">Maintenance information</span>
                            </p>
                            
                            <!-- Custom fields will appear here -->
                            <div id="preview-custom-fields" class="space-y-2 border-t border-gray-100 pt-2 mt-2">
                                <!-- Custom fields will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card p-4">
                <h4 class="text-sm font-medium mb-3">QR Code Preview</h4>
                <div class="flex justify-center">
                    <div class="qr-preview p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="w-32 h-32 bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-qrcode text-gray-400 text-4xl"></i>
                        </div>
                        <p class="text-center text-xs mt-2 text-gray-500">Scan for product details</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Tips for effective product tags</h3>
                        <ul class="mt-2 text-sm text-blue-700 list-disc list-inside">
                            <li>Use clear, descriptive product names</li>
                            <li>Keep maintenance information concise and specific</li>
                            <li>Choose contrasting colors for better readability</li>
                            <li>Ensure accurate model and serial numbers</li>
                            <li>Always include current location information</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Field Modal -->
<div id="custom-field-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full transform transition-all">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800" id="modal-title">Add Custom Field</h3>
                <button type="button" class="text-gray-400 hover:text-gray-500" id="close-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="custom-field-form" class="space-y-4">
                <input type="hidden" id="edit-field-index" value="-1">
                
                <div class="form-group">
                    <label for="custom-field-name" class="form-label">Field Name</label>
                    <input type="text" id="custom-field-name" class="form-input" placeholder="Enter field name" required>
                </div>
                
                <div class="form-group">
                    <label for="custom-field-type" class="form-label">Field Type</label>
                    <select id="custom-field-type" class="form-input">
                        <option value="text">Text</option>
                        <option value="number">Number</option>
                        <option value="date">Date</option>
                        <option value="email">Email</option>
                        <option value="url">URL</option>
                        <option value="phone">Phone</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Icon</label>
                    <div class="grid grid-cols-8 gap-2 mt-2 border border-gray-200 rounded-lg p-2 bg-gray-50">
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors active" data-icon="fa-star">
                            <i class="fas fa-star text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-info-circle">
                            <i class="fas fa-info-circle text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-link">
                            <i class="fas fa-link text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-calendar">
                            <i class="fas fa-calendar text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-clock">
                            <i class="fas fa-clock text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-hashtag">
                            <i class="fas fa-hashtag text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-phone">
                            <i class="fas fa-phone text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-envelope">
                            <i class="fas fa-envelope text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-clipboard">
                            <i class="fas fa-clipboard text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-file">
                            <i class="fas fa-file text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-user">
                            <i class="fas fa-user text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-users">
                            <i class="fas fa-users text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-tag">
                            <i class="fas fa-tag text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-tags">
                            <i class="fas fa-tags text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-key">
                            <i class="fas fa-key text-gray-600"></i>
                        </button>
                        <button type="button" class="icon-option w-8 h-8 rounded flex items-center justify-center hover:bg-gray-200 transition-colors" data-icon="fa-dollar-sign">
                            <i class="fas fa-dollar-sign text-gray-600"></i>
                        </button>
                    </div>
                    <input type="hidden" id="custom-field-icon" value="fa-star">
                </div>
                
                <div class="form-group">
                    <label for="custom-field-default" class="form-label">Default Value (optional)</label>
                    <input type="text" id="custom-field-default" class="form-input" placeholder="Enter default value">
                </div>
                
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" class="btn-secondary" id="cancel-custom-field">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-1"></i> Save Field
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Define global variables for custom fields
        let customFieldsCount = 0;
        let customFields = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all form components
            initializeSteps();
            initializeColorPickers();
            initializeCardLayouts();
            initializeImageUpload();
            initializeTemplates();
            initializeCustomFields();
            updateTagPreview();
            
            // Step navigation
            function initializeSteps() {
                const steps = document.querySelectorAll('.step');
                const formSections = document.querySelectorAll('.form-section');
                const nextButtons = document.querySelectorAll('.next-step');
                const prevButtons = document.querySelectorAll('.prev-step');
                const stepIndicator = document.querySelector('.step-indicator');
                const progressBars = document.querySelectorAll('.step-progress');
                
                // Update step indicator text
                function updateStepIndicator(currentStep) {
                    if (stepIndicator) {
                        stepIndicator.textContent = `Step ${currentStep} of 3`;
                    }
                }
                
                // Update progress bars
                function updateProgressBars(currentStep) {
                    if (progressBars.length >= 2) {
                        if (currentStep >= 2) {
                            progressBars[0].style.width = '100%';
                        } else {
                            progressBars[0].style.width = '0%';
                        }
                        
                        if (currentStep >= 3) {
                            progressBars[1].style.width = '100%';
                        } else {
                            progressBars[1].style.width = '0%';
                        }
                    }
                }
                
                // Navigate to step
                function goToStep(stepNumber) {
                    // Hide all sections
                    formSections.forEach(section => section.classList.add('hidden'));
                    
                    // Show selected section
                    const targetSection = document.querySelector(`.form-section[data-step="${stepNumber}"]`);
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }
                    
                    // Update step indicators
                    steps.forEach(step => {
                        const stepNum = parseInt(step.getAttribute('data-step'));
                        step.classList.remove('active');
                        
                        const stepCircle = step.querySelector('.step-circle');
                        if (stepCircle) {
                            stepCircle.classList.remove('bg-primary-600', 'text-white');
                            stepCircle.classList.add('bg-gray-200', 'text-gray-600');
                        }
                        
                        if (stepNum <= stepNumber) {
                            step.classList.add('active');
                            if (stepCircle) {
                                stepCircle.classList.remove('bg-gray-200', 'text-gray-600');
                                stepCircle.classList.add('bg-primary-600', 'text-white');
                            }
                        }
                    });
                    
                    updateStepIndicator(stepNumber);
                    updateProgressBars(stepNumber);
                    
                    // Scroll to top of form
                    const formTop = document.getElementById('product-form').getBoundingClientRect().top + window.pageYOffset - 100;
                    window.scrollTo({top: formTop, behavior: 'smooth'});
                }
                
                window.goToStep = goToStep; // Make accessible globally for use in other functions
                
                // Next step buttons
                nextButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const nextStep = parseInt(this.getAttribute('data-next'));
                        if (validateStep(nextStep - 1)) {
                            goToStep(nextStep);
                        }
                    });
                });
                
                // Previous step buttons
                prevButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const prevStep = parseInt(this.getAttribute('data-prev'));
                        goToStep(prevStep);
                    });
                });
                
                // Step circle clicks
                steps.forEach(step => {
                    step.addEventListener('click', function() {
                        const targetStep = parseInt(this.getAttribute('data-step'));
                        const currentStepNum = getCurrentStep();
                        
                        // Only allow clicking on previous steps or the next step
                        if (targetStep <= currentStepNum || targetStep === currentStepNum + 1) {
                            if (targetStep > currentStepNum && !validateStep(currentStepNum)) {
                                return; // Don't proceed if current step isn't valid
                            }
                            goToStep(targetStep);
                        }
                    });
                });
                
                // Get current step
                function getCurrentStep() {
                    const visibleSection = document.querySelector('.form-section:not(.hidden)');
                    return visibleSection ? parseInt(visibleSection.getAttribute('data-step')) : 1;
                }
                
                // Validate step before proceeding
                function validateStep(stepNumber) {
                    let isValid = true;
                    
                    if (stepNumber === 1) {
                        // Validate required fields in step 1
                        const requiredFields = document.querySelectorAll('.form-section[data-step="1"] [required]');
                        requiredFields.forEach(field => {
                            if (!field.value.trim()) {
                                isValid = false;
                                field.classList.add('border-red-500');
                                
                                // Show validation error
                                const errorSpan = field.parentNode.nextElementSibling;
                                if (errorSpan && errorSpan.classList.contains('form-error')) {
                                    errorSpan.textContent = 'This field is required';
                                }
                            }
                        });
                        
                        if (!isValid) {
                            // Focus first invalid field
                            const firstInvalid = document.querySelector('.form-section[data-step="1"] .border-red-500');
                            if (firstInvalid) {
                                firstInvalid.focus();
                            }
                            
                            // Show notification
                            showNotification('Please fill in all required fields in step 1', 'error');
                        }
                    }
                    
                    if (stepNumber === 2) {
                        // Validate required fields in step 2
                        const requiredFields = document.querySelectorAll('.form-section[data-step="2"] [required]');
                        requiredFields.forEach(field => {
                            if (!field.value.trim()) {
                                isValid = false;
                                field.classList.add('border-red-500');
                                
                                // Show validation error
                                const errorSpan = field.parentNode.nextElementSibling;
                                if (errorSpan && errorSpan.classList.contains('form-error')) {
                                    errorSpan.textContent = 'This field is required';
                                }
                            }
                        });
                        
                        if (!isValid) {
                            // Focus first invalid field
                            const firstInvalid = document.querySelector('.form-section[data-step="2"] .border-red-500');
                            if (firstInvalid) {
                                firstInvalid.focus();
                            }
                            
                            // Show notification
                            showNotification('Please fill in all required fields in step 2', 'error');
                        }
                    }
                    
                    return isValid;
                }
                
                // Live validation on blur
                const requiredInputs = document.querySelectorAll('[required]');
                requiredInputs.forEach(input => {
                    input.addEventListener('blur', function() {
                        if (!this.value.trim()) {
                            this.classList.add('border-red-500');
                            
                            // Show validation error
                            const errorSpan = this.parentNode.nextElementSibling;
                            if (errorSpan && errorSpan.classList.contains('form-error')) {
                                errorSpan.textContent = 'This field is required';
                            }
                        } else {
                            this.classList.remove('border-red-500');
                            
                            // Clear validation error
                            const errorSpan = this.parentNode.nextElementSibling;
                            if (errorSpan && errorSpan.classList.contains('form-error')) {
                                errorSpan.textContent = '';
                            }
                            
                            // Show validation success icon
                            const validIcon = this.parentNode.querySelector('.validation-icon');
                            if (validIcon) {
                                validIcon.classList.remove('hidden');
                            }
                        }
                    });
                    
                    input.addEventListener('input', function() {
                        if (this.value.trim()) {
                            this.classList.remove('border-red-500');
                            
                            // Clear validation error
                            const errorSpan = this.parentNode.nextElementSibling;
                            if (errorSpan && errorSpan.classList.contains('form-error')) {
                                errorSpan.textContent = '';
                            }
                        }
                        
                        // Update preview
                        updateTagPreview();
                    });
                });
            }
            
            // Initialize color pickers
            function initializeColorPickers() {
                const colorInputs = document.querySelectorAll('.color-input');
                const colorPresets = document.querySelectorAll('.color-preset');

                const colorPreviews = document.querySelectorAll('.color-preview');
                colorPreviews.forEach(preview => {
                    preview.addEventListener('click', function() {
                        const inputId = this.id.replace('-preview', '-picker');
                        const colorInput = document.getElementById(inputId);
                        if (colorInput) {
                            colorInput.click();
                        }
                    });
                });
                    
                // Connect color inputs to text inputs
                colorInputs.forEach(input => {
                    input.addEventListener('input', function() {
                        const previewId = this.id.replace('-picker', '-preview');
                        const colorPreview = document.getElementById(previewId);
                        const textInput = this.parentNode.querySelector('input[type="text"]');
                        
                        if (colorPreview) {
                            colorPreview.style.backgroundColor = this.value;
                        }
                        
                        if (textInput) {
                            textInput.value = this.value;
                        }
                        
                        updateTagPreview();
                    });
                });
                
                // Connect text inputs to color pickers
                const textColorInputs = document.querySelectorAll('input[type="text"][id$="Color"]');
                textColorInputs.forEach(input => {
                    if (input.id.includes('Color')) {
                        input.addEventListener('input', function() {
                            // Get the associated color input (sibling in flex container)
                            const colorInput = this.parentNode.querySelector('.color-input');
                            
                            if (colorInput) {
                                colorInput.value = this.value;
                            }
                            
                            updateTagPreview();
                        });
                    }
                });
                
                // Color presets
                colorPresets.forEach(preset => {
                    preset.addEventListener('click', function() {
                        const color = this.getAttribute('data-color');
                        const wrapper = this.closest('.color-picker-wrapper');
                        
                        if (wrapper) {
                            const colorInput = wrapper.querySelector('.color-input');
                            const textInput = wrapper.querySelector('input[type="text"]');
                            
                            if (colorInput) colorInput.value = color;
                            if (textInput) textInput.value = color;
                            
                            // Visual feedback
                            this.classList.add('ring-2', 'ring-primary-500', 'scale-125');
                            setTimeout(() => {
                                this.classList.remove('ring-2', 'ring-primary-500', 'scale-125');
                            }, 300);
                            
                            updateTagPreview();
                        }
                    });
                });
                
                // QR code color pickers
                const qrFgColor = document.getElementById('qr-fg-color');
                const qrFgColorText = document.getElementById('qr-fg-color-text');
                const qrBgColor = document.getElementById('qr-bg-color');
                const qrBgColorText = document.getElementById('qr-bg-color-text');
                
                if (qrFgColor && qrFgColorText) {
                    qrFgColor.addEventListener('input', function() {
                        qrFgColorText.value = this.value;
                        document.getElementById('qrFgColorHidden').value = this.value;
                    });
                    
                    qrFgColorText.addEventListener('input', function() {
                        qrFgColor.value = this.value;
                        document.getElementById('qrFgColorHidden').value = this.value;
                    });
                }
                
                if (qrBgColor && qrBgColorText) {
                    qrBgColor.addEventListener('input', function() {
                        qrBgColorText.value = this.value;
                        document.getElementById('qrBgColorHidden').value = this.value;
                    });
                    
                    qrBgColorText.addEventListener('input', function() {
                        qrBgColor.value = this.value;
                        document.getElementById('qrBgColorHidden').value = this.value;
                    });
                }
            }
            
            // Card layout selection
            function initializeCardLayouts() {
                const layoutOptions = document.querySelectorAll('.layout-option');
                const layoutHidden = document.getElementById('layoutHidden');
                
                layoutOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        // Remove active class from all options
                        layoutOptions.forEach(opt => opt.classList.remove('border-primary-500', 'active'));
                        
                        // Add active class to selected option
                        this.classList.add('border-primary-500', 'active');
                        
                        // Get layout type
                        const layoutType = this.getAttribute('data-layout');
                        
                        // Update hidden input value to save the selection
                        layoutHidden.value = layoutType;
                        
                        // Update preview
                        updateCardLayout(layoutType);
                    });
                });
                
                // Initialize with first layout
                const firstLayout = document.querySelector('.layout-option');
                if (firstLayout) {
                    firstLayout.classList.add('border-primary-500', 'active');
                }
                
                // Card preview controls
                const rotateBtn = document.getElementById('rotate-preview');
                const zoomBtn = document.getElementById('zoom-preview');
                const previewContainer = document.getElementById('card-preview-container');
                
                if (rotateBtn && previewContainer) {
                    rotateBtn.addEventListener('click', function() {
                        previewContainer.classList.toggle('rotate-y-180');
                    });
                }
                
                if (zoomBtn && previewContainer) {
                    zoomBtn.addEventListener('click', function() {
                        previewContainer.classList.toggle('scale-110');
                    });
                }
            }
            
            // Apply layout to preview
            function updateCardLayout(layoutType) {
                const preview = document.getElementById('tag-preview');
                if (!preview) return;
                
                // Reset classes
                preview.className = 'business-card';
                
                // Apply layout specific classes
                if (layoutType === 'modern') {
                    // Modern layout with header bar
                    const content = preview.querySelector('div');
                    if (content) {
                        content.className = 'h-full flex flex-col';
                        content.innerHTML = `
                            <div class="h-8 w-full rounded-t-lg" style="background-color: ${document.getElementById('accent-color-picker').value}"></div>
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 id="preview-name" class="text-xl font-bold" style="color: ${document.getElementById('accent-color-picker').value}">${document.getElementById('ProductName').value || 'Product Name'}</h3>
                                <p id="preview-manufacturer" class="text-md">${document.getElementById('Manufacturer').value || 'Manufacturer'}</p>
                                <div class="flex items-center space-x-2 mt-1 text-sm">
                                    <span class="font-semibold">Model:</span>
                                    <span id="preview-model">${document.getElementById('ModelNumber').value || 'MODEL-XXX'}</span>
                                </div>
                                <div class="space-y-2 mt-auto text-sm">
                                    <p class="flex items-center">
                                        <i class="fas fa-map-marker-alt mr-3" style="color: ${document.getElementById('accent-color-picker').value}"></i>
                                        <span class="font-medium">Location:</span>&nbsp;<span id="preview-location">${document.getElementById('Location').value || 'Storage Location'}</span>
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-calendar-check mr-3" style="color: ${document.getElementById('accent-color-picker').value}"></i>
                                        <span class="font-medium">Warranty:</span>&nbsp;<span id="preview-warranty">${formatDate(document.getElementById('WarrantyExpiration').value) || 'Jan 1, 2026'}</span>
                                    </p>
                                    <div id="preview-custom-fields" class="space-y-2 border-t border-gray-100 pt-2 mt-2">
                                        <!-- Custom fields will be dynamically added here -->
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Update custom fields in preview
                        updateCustomFieldsPreview();
                    }
                } else if (layoutType === 'compact') {
                    // Compact layout with side QR
                    const content = preview.querySelector('div');
                    if (content) {
                        content.className = 'h-full flex';
                        content.innerHTML = `
                            <div class="flex-grow p-4">
                                <span id="preview-category" class="px-2 py-1 text-xs font-semibold rounded-full" style="background-color: ${document.getElementById('accent-color-picker').value}; color: ${document.getElementById('bg-color-picker').value || '#ffffff'}">
                                    ${document.getElementById('Category').value || 'Product Category'}
                                </span>
                                <h3 id="preview-name" class="text-lg font-bold mt-2" style="color: ${document.getElementById('accent-color-picker').value}">${document.getElementById('ProductName').value || 'Product Name'}</h3>
                                <div class="space-y-1 mt-3 text-xs">
                                    <p class="flex items-center">
                                        <i class="fas fa-industry mr-2" style="color: ${document.getElementById('accent-color-picker').value}"></i>
                                        ${document.getElementById('Manufacturer').value || 'Manufacturer'}
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-tag mr-2" style="color: ${document.getElementById('accent-color-picker').value}"></i>
                                        ${document.getElementById('ModelNumber').value || 'MODEL-XXX'}
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-fingerprint mr-2" style="color: ${document.getElementById('accent-color-picker').value}"></i>
                                        ${document.getElementById('SerialNumber').value || 'SN12345'}
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-map-marker-alt mr-2" style="color: ${document.getElementById('accent-color-picker').value}"></i>
                                        ${document.getElementById('Location').value || 'Storage Location'}
                                    </p>
                                    <div id="preview-custom-fields" class="space-y-1 mt-2 pt-2 border-t border-gray-100">
                                        <!-- Custom fields will be dynamically added here -->
                                    </div>
                                </div>
                            </div>
                            <div class="w-1/3 bg-gray-50 rounded-r-lg flex items-center justify-center">
                                <div class="text-center">
                                    <div class="w-16 h-16 mx-auto bg-white p-1 rounded shadow-sm">
                                        <i class="fas fa-qrcode text-2xl text-gray-400"></i>
                                    </div>
                                    <p class="text-xs mt-1">Scan</p>
                                </div>
                            </div>
                        `;
                        
                        // Update custom fields in preview
                        updateCustomFieldsPreview();
                    }
                } else {
                    // Standard layout
                    updateTagPreview();
                }
            }
            
            // Image upload handling
            function initializeImageUpload() {
                const dropzone = document.getElementById('dropzone');
                const fileInput = document.getElementById('product-image');
                const imagePreview = document.getElementById('image-preview');
                const removeButton = document.getElementById('remove-image');
                
                if (!dropzone || !fileInput || !imagePreview || !removeButton) return;
                
                dropzone.addEventListener('click', function() {
                    fileInput.click();
                });
                
                dropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('border-primary-400', 'bg-primary-50');
                });
                
                dropzone.addEventListener('dragleave', function() {
                    this.classList.remove('border-primary-400', 'bg-primary-50');
                });
                
                dropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('border-primary-400', 'bg-primary-50');
                    
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileUpload(e.dataTransfer.files[0]);
                    }
                });
                
                fileInput.addEventListener('change', function() {
                    if (this.files.length) {
                        handleFileUpload(this.files[0]);
                    }
                });
                
                removeButton.addEventListener('click', function() {
                    fileInput.value = '';
                    imagePreview.classList.add('hidden');
                    dropzone.classList.remove('hidden');
                });
                
                function handleFileUpload(file) {
                    // Validate file type and size
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    
                    if (!validTypes.includes(file.type)) {
                        showNotification('Invalid file type. Please upload a JPG, PNG, or GIF.', 'error');
                        return;
                    }
                    
                    if (file.size > maxSize) {
                        showNotification('File is too large. Maximum size is 5MB.', 'error');
                        return;
                    }
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = imagePreview.querySelector('img');
                        const filename = imagePreview.querySelector('.filename');
                        
                        if (img && filename) {
                            img.src = e.target.result;
                            filename.textContent = file.name;
                        }
                        
                        dropzone.classList.add('hidden');
                        imagePreview.classList.remove('hidden');
                        
                        showNotification('Image uploaded successfully', 'success');
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
            
            // Initialize custom fields
            function initializeCustomFields() {
                const addCustomFieldBtn = document.getElementById('add-custom-field');
                const addFirstCustomFieldBtn = document.getElementById('add-first-custom-field');
                const customFieldsContainer = document.getElementById('custom-fields-container');
                const customFieldsList = document.querySelector('.custom-fields-list');
                const customFieldsEmpty = document.getElementById('custom-fields-empty');
                const customFieldTemplate = document.getElementById('custom-field-template');
                const customFieldModal = document.getElementById('custom-field-modal');
                const closeModalBtn = document.getElementById('close-modal');
                const cancelCustomFieldBtn = document.getElementById('cancel-custom-field');
                const customFieldForm = document.getElementById('custom-field-form');
                const iconOptions = document.querySelectorAll('.icon-option');
                
                // Add custom field button click
                addCustomFieldBtn.addEventListener('click', function() {
                    openCustomFieldModal();
                });
                
                addFirstCustomFieldBtn.addEventListener('click', function() {
                    openCustomFieldModal();
                });
                
                // Close modal buttons
                closeModalBtn.addEventListener('click', closeCustomFieldModal);
                cancelCustomFieldBtn.addEventListener('click', closeCustomFieldModal);
                
                // Close modal when clicking outside
                customFieldModal.addEventListener('click', function(e) {
                    if (e.target === customFieldModal) {
                        closeCustomFieldModal();
                    }
                });
                
                // Icon selection
                iconOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        iconOptions.forEach(opt => opt.classList.remove('bg-primary-100', 'active'));
                        this.classList.add('bg-primary-100', 'active');
                        document.getElementById('custom-field-icon').value = this.getAttribute('data-icon');
                    });
                });
                
                // Custom field form submission
                customFieldForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const fieldName = document.getElementById('custom-field-name').value;
                    const fieldType = document.getElementById('custom-field-type').value;
                    const fieldIcon = document.getElementById('custom-field-icon').value;
                    const fieldDefault = document.getElementById('custom-field-default').value;
                    const editIndex = parseInt(document.getElementById('edit-field-index').value);
                    
                    if (editIndex >= 0) {
                        // Update existing field
                        updateCustomField(editIndex, fieldName, fieldType, fieldIcon, fieldDefault);
                    } else {
                        // Add new field
                        addCustomField(fieldName, fieldType, fieldIcon, fieldDefault);
                    }
                    
                    closeCustomFieldModal();
                    updateTagPreview();
                });
                
                // Open custom field modal
                function openCustomFieldModal(fieldIndex = -1) {
                    // Clear the form
                    customFieldForm.reset();
                    document.getElementById('edit-field-index').value = fieldIndex;
                    
                    // Reset icon selection
                    iconOptions.forEach(opt => opt.classList.remove('bg-primary-100', 'active'));
                    iconOptions[0].classList.add('bg-primary-100', 'active');
                    document.getElementById('custom-field-icon').value = 'fa-star';
                    
                    // Set title
                    document.getElementById('modal-title').textContent = fieldIndex >= 0 ? 'Edit Custom Field' : 'Add Custom Field';
                    
                    // If editing, populate form with existing field data
                    if (fieldIndex >= 0) {
                        const field = customFields[fieldIndex];
                        document.getElementById('custom-field-name').value = field.name;
                        document.getElementById('custom-field-type').value = field.type;
                        document.getElementById('custom-field-default').value = field.value;
                        document.getElementById('custom-field-icon').value = field.icon;
                        
                        // Select the corresponding icon
                        iconOptions.forEach(opt => {
                            if (opt.getAttribute('data-icon') === field.icon) {
                                opt.classList.add('bg-primary-100', 'active');
                            }
                        });
                    }
                    
                    // Show the modal
                    customFieldModal.classList.remove('hidden');
                }
                
                // Close custom field modal
                function closeCustomFieldModal() {
                    customFieldModal.classList.add('hidden');
                }
                
                // Add custom field
                function addCustomField(name, type, icon, defaultValue = '') {
                    // Create new field
                    const fieldId = `custom-field-${customFieldsCount}`;
                    const field = {
                        id: fieldId,
                        name: name,
                        type: type,
                        icon: icon,
                        value: defaultValue
                    };
                    
                    // Add to fields array
                    customFields.push(field);
                    
                    // Create DOM element
                    const newField = customFieldTemplate.cloneNode(true);
                    newField.id = fieldId;
                    newField.classList.remove('hidden');
                    
                    // Set field content
                    newField.querySelector('.custom-field-label').textContent = name;
                    newField.querySelector('.custom-field-input').name = `custom_fields[${customFieldsCount}][value]`;
                    newField.querySelector('.custom-field-input').value = defaultValue;
                    newField.querySelector('.custom-field-input').placeholder = `Enter ${name}`;
                    
                    // Set field type
                    newField.querySelector('.custom-field-input').type = type === 'number' ? 'number' : 
                                                                         type === 'date' ? 'date' : 
                                                                         type === 'email' ? 'email' : 
                                                                         type === 'url' ? 'url' : 
                                                                         type === 'phone' ? 'tel' : 'text';
                    
                    // Set hidden values
                    newField.querySelector('.custom-field-key').name = `custom_fields[${customFieldsCount}][key]`;
                    newField.querySelector('.custom-field-key').value = name.toLowerCase().replace(/\s+/g, '_');
                    
                    newField.querySelector('.custom-field-type').name = `custom_fields[${customFieldsCount}][type]`;
                    newField.querySelector('.custom-field-type').value = type;
                    
                    newField.querySelector('.custom-field-icon').name = `custom_fields[${customFieldsCount}][icon]`;
                    newField.querySelector('.custom-field-icon').value = icon;
                    
                    // Set icon
                    newField.querySelector('.custom-field-icon-display i').className = `fas ${icon}`;
                    
                    // Add event listeners
                    newField.querySelector('.edit-custom-field').addEventListener('click', function() {
                        const fieldIndex = customFields.findIndex(f => f.id === fieldId);
                        if (fieldIndex >= 0) {
                            openCustomFieldModal(fieldIndex);
                        }
                    });
                    
                    newField.querySelector('.remove-custom-field').addEventListener('click', function() {
                        const fieldIndex = customFields.findIndex(f => f.id === fieldId);
                        if (fieldIndex >= 0) {
                            customFields.splice(fieldIndex, 1);
                            newField.remove();
                            
                            // Show empty state if no fields
                            if (customFields.length === 0) {
                                customFieldsEmpty.classList.remove('hidden');
                            }
                            
                            updateTagPreview();
                        }
                    });
                    
                    // Add input change handler to update preview
                    newField.querySelector('.custom-field-input').addEventListener('input', function() {
                        const fieldIndex = customFields.findIndex(f => f.id === fieldId);
                        if (fieldIndex >= 0) {
                            customFields[fieldIndex].value = this.value;
                            updateTagPreview();
                        }
                    });
                    
                    // Append to list
                    customFieldsList.appendChild(newField);
                    
                    // Increment counter
                    customFieldsCount++;
                    
                    // Hide empty state
                    customFieldsEmpty.classList.add('hidden');
                    
                    return field;
                }
                
                // Update existing custom field
                function updateCustomField(index, name, type, icon, value) {
                    const field = customFields[index];
                    if (!field) return;
                    
                    // Update field data
                    field.name = name;
                    field.type = type;
                    field.icon = icon;
                    field.value = value;
                    
                    // Update DOM element
                    const fieldElement = document.getElementById(field.id);
                    if (fieldElement) {
                        fieldElement.querySelector('.custom-field-label').textContent = name;
                        
                        const inputElement = fieldElement.querySelector('.custom-field-input');
                        inputElement.value = value;
                        inputElement.placeholder = `Enter ${name}`;
                        inputElement.type = type === 'number' ? 'number' : 
                                            type === 'date' ? 'date' : 
                                            type === 'email' ? 'email' : 
                                            type === 'url' ? 'url' : 
                                            type === 'phone' ? 'tel' : 'text';
                        
                        // Update hidden values
                        fieldElement.querySelector('.custom-field-key').value = name.toLowerCase().replace(/\s+/g, '_');
                        fieldElement.querySelector('.custom-field-type').value = type;
                        fieldElement.querySelector('.custom-field-icon').value = icon;
                        
                        // Update icon
                        fieldElement.querySelector('.custom-field-icon-display i').className = `fas ${icon}`;
                    }
                }
                
                // Add to window for global access
                window.customFieldsManager = {
                    addCustomField,
                    updateCustomField,
                    openCustomFieldModal,
                    closeCustomFieldModal
                };
            }
            
            // Update custom fields in preview
            function updateCustomFieldsPreview() {
                const previewCustomFields = document.getElementById('preview-custom-fields');
                if (!previewCustomFields) return;
                
                // Clear existing fields
                previewCustomFields.innerHTML = '';
                
                // If no custom fields, hide the container
                if (customFields.length === 0) {
                    previewCustomFields.style.display = 'none';
                    return;
                }
                
                // Show the container
                previewCustomFields.style.display = 'block';
                
                // Get card layout type
                const layoutType = document.querySelector('.layout-option.active').getAttribute('data-layout');
                const isCompact = layoutType === 'compact';
                
                // Add each custom field
                customFields.forEach(field => {
                    const fieldElement = document.createElement('p');
                    fieldElement.className = 'flex items-center';
                    
                    const iconMargin = isCompact ? 'mr-2' : 'mr-3';
                    
                    fieldElement.innerHTML = `
                        <i class="fas ${field.icon} ${iconMargin}" style="color: ${document.getElementById('accent-color-picker').value}"></i>
                        <span class="font-medium">${field.name}:</span>&nbsp;<span>${field.value || 'â'}</span>
                    `;
                    
                    previewCustomFields.appendChild(fieldElement);
                });
            }
            
            // Template application
            function initializeTemplates() {
                const templates = document.querySelectorAll('.template-card');
                const showMoreTemplatesBtn = document.getElementById('show-more-templates');
                const hideMoreTemplatesBtn = document.getElementById('hide-more-templates');
                const advancedTemplates = document.getElementById('advanced-templates');
                
                // Show/hide advanced templates
                if (showMoreTemplatesBtn && hideMoreTemplatesBtn && advancedTemplates) {
                    showMoreTemplatesBtn.addEventListener('click', function() {
                        advancedTemplates.classList.remove('hidden');
                        showMoreTemplatesBtn.classList.add('hidden');
                        hideMoreTemplatesBtn.classList.remove('hidden');
                    });
                    
                    hideMoreTemplatesBtn.addEventListener('click', function() {
                        advancedTemplates.classList.add('hidden');
                        showMoreTemplatesBtn.classList.remove('hidden');
                        hideMoreTemplatesBtn.classList.add('hidden');
                    });
                }
                
                templates.forEach(template => {
                    template.addEventListener('click', function() {
                        const templateType = this.getAttribute('data-template');
                        
                        // Highlight selected template
                        templates.forEach(t => t.classList.remove('border-primary-500'));
                        this.classList.add('border-primary-500');
                        
                        // Apply template
                        applyTemplate(templateType);
                    });
                });
            }
            
            // Apply predefined templates
            function applyTemplate(type) {
                // Reset custom fields
                customFields = [];
                document.querySelector('.custom-fields-list').innerHTML = '';
                document.querySelector('.custom-fields-list').appendChild(document.getElementById('custom-field-template'));
                document.getElementById('custom-fields-empty').classList.remove('hidden');
                
                // Common fields setup function
                function setupCommonFields(data) {
                    document.getElementById('ProductName').value = data.name;
                    document.getElementById('Category').value = data.category;
                    document.getElementById('Manufacturer').value = data.manufacturer;
                    document.getElementById('ModelNumber').value = data.model;
                    document.getElementById('SerialNumber').value = data.serial;
                    document.getElementById('Location').value = data.location;
                    document.getElementById('MaintenanceInfo').value = data.maintenance;
                    
                    // Set dates
                    const today = new Date();
                    const manufactureDate = new Date(today);
                    manufactureDate.setMonth(manufactureDate.getMonth() - data.ageMonths);
                    
                    const purchaseDate = new Date(today);
                    purchaseDate.setMonth(purchaseDate.getMonth() - data.ageMonths + 1);
                    
                    const warrantyDate = new Date(today);
                    warrantyDate.setFullYear(warrantyDate.getFullYear() + data.warrantyYears);
                    
                    document.getElementById('ManufactureDate').value = formatDateForInput(manufactureDate);
                    document.getElementById('PurchaseDate').value = formatDateForInput(purchaseDate);
                    document.getElementById('WarrantyExpiration').value = formatDateForInput(warrantyDate);
                    
                    // Set colors
                    document.getElementById('bg-color-picker').value = data.colors.bg;
                    document.getElementById('text-color-picker').value = data.colors.text;
                    document.getElementById('accent-color-picker').value = data.colors.accent;
                    
                    // Update text inputs
                    document.getElementById('BackgroundColor').value = data.colors.bg;
                    document.getElementById('TextColor').value = data.colors.text;
                    document.getElementById('AccentColor').value = data.colors.accent;
                    
                    // Add custom fields
                    if (data.customFields && data.customFields.length) {
                        data.customFields.forEach(field => {
                            window.customFieldsManager.addCustomField(
                                field.name,
                                field.type,
                                field.icon,
                                field.value
                            );
                        });
                        
                        // Hide empty state
                        document.getElementById('custom-fields-empty').classList.add('hidden');
                    }
                    
                    // Set card layout if specified
                    if (data.layout) {
                        const layoutOption = document.querySelector(`.layout-option[data-layout="${data.layout}"]`);
                        if (layoutOption) {
                            // Trigger click to update layout
                            layoutOption.click();
                        }
                    }
                    
                    showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} template applied successfully`, 'success');
                }
                
                if (type === 'chemical') {
                    setupCommonFields({
                        name: 'RustShield Pro 5000',
                        category: 'Rust Coating Chemical',
                        manufacturer: 'ChemTech Industries',
                        model: 'RS-5000-X',
                        serial: 'CT20250001',
                        location: 'Chemical Storage Room A',
                        maintenance: 'Store at 10-15Â°C, away from direct sunlight. Rotate stock every 6 months.',
                        ageMonths: 2,
                        warrantyYears: 2,
                        colors: {
                            bg: '#ffffff',
                            text: '#1e293b',
                            accent: '#0284c7'
                        },
                        layout: 'standard',
                        customFields: [
                            {
                                name: 'Safety Class',
                                type: 'text',
                                icon: 'fa-exclamation-triangle',
                                value: 'Class B - Moderate'
                            },
                            {
                                name: 'Batch Number',
                                type: 'text',
                                icon: 'fa-hashtag',
                                value: 'BN-2025-4872'
                            }
                        ]
                    });
                    
                } else if (type === 'equipment') {
                    setupCommonFields({
                        name: 'Industrial Spray Booth',
                        category: 'Application Equipment',
                        manufacturer: 'SprayTech',
                        model: 'SB-2000',
                        serial: 'ST2024789',
                        location: 'Building 2, Bay 4',
                        maintenance: 'Filter replacement every 3 months. Monthly calibration check required.',
                        ageMonths: 4,
                        warrantyYears: 3,
                        colors: {
                            bg: '#f8fafc',
                            text: '#334155',
                            accent: '#6366f1'
                        },
                        layout: 'modern',
                        customFields: [
                            {
                                name: 'Last Service',
                                type: 'date',
                                icon: 'fa-calendar-check',
                                value: formatDateForInput(new Date())
                            },
                            {
                                name: 'Service Contact',
                                type: 'phone',
                                icon: 'fa-phone',
                                value: '+66 123-456-7890'
                            },
                            {
                                name: 'Power Rating',
                                type: 'text',
                                icon: 'fa-bolt',
                                value: '240V / 30A'
                            }
                        ]
                    });
                    
                } else if (type === 'safety') {
                    setupCommonFields({
                        name: 'Emergency Eye Wash Station',
                        category: 'Safety Equipment',
                        manufacturer: 'SafetyFirst Inc.',
                        model: 'EW-100',
                        serial: 'SF20245582',
                        location: 'Chemical Processing Area',
                        maintenance: 'Weekly testing required. Monthly full inspection. Maintain water pressure of 30-90 PSI.',
                        ageMonths: 6,
                        warrantyYears: 5,
                        colors: {
                            bg: '#fffbeb',
                            text: '#451a03',
                            accent: '#ea580c'
                        },
                        layout: 'compact',
                        customFields: [
                            {
                                name: 'Last Test',
                                type: 'date',
                                icon: 'fa-calendar',
                                value: formatDateForInput(new Date())
                            },
                            {
                                name: 'Inspection Frequency',
                                type: 'text',
                                icon: 'fa-clock',
                                value: 'Weekly'
                            },
                            {
                                name: 'Safety Coordinator',
                                type: 'text',
                                icon: 'fa-user',
                                value: 'Somchai Jaidee'
                            }
                        ]
                    });
                    
                } else if (type === 'office') {
                    setupCommonFields({
                        name: 'ThinkPad X1 Carbon',
                        category: 'Office Equipment',
                        manufacturer: 'Lenovo',
                        model: 'X1 Carbon Gen 10',
                        serial: 'LNV204925XC',
                        location: 'Engineering Dept, 3rd Floor',
                        maintenance: 'Monthly OS updates. Annual hardware checkup by IT.',
                        ageMonths: 8,
                        warrantyYears: 3,
                        colors: {
                            bg: '#f0f9ff',
                            text: '#0f172a',
                            accent: '#0ea5e9'
                        },
                        layout: 'standard',
                        customFields: [
                            {
                                name: 'Assigned To',
                                type: 'text',
                                icon: 'fa-user',
                                value: 'Pranee Chanthasad'
                            },
                            {
                                name: 'IT Tag',
                                type: 'text',
                                icon: 'fa-tag',
                                value: 'IT-LT-2254'
                            },
                            {
                                name: 'IP Address',
                                type: 'text',
                                icon: 'fa-network-wired',
                                value: '192.168.1.45'
                            }
                        ]
                    });
                    
                } else if (type === 'laboratory') {
                    setupCommonFields({
                        name: 'Digital Microscope XM200',
                        category: 'Lab Equipment',
                        manufacturer: 'OpticalPro',
                        model: 'XM200-HD',
                        serial: 'OP2025768Q',
                        location: 'Quality Control Lab, Room 105',
                        maintenance: 'Monthly lens cleaning. Bi-annual calibration required.',
                        ageMonths: 5,
                        warrantyYears: 2,
                        colors: {
                            bg: '#f5f3ff',
                            text: '#1e1b4b',
                            accent: '#7c3aed'
                        },
                        layout: 'modern',
                        customFields: [
                            {
                                name: 'Magnification',
                                type: 'text',
                                icon: 'fa-search-plus',
                                value: '50-1000x'
                            },
                            {
                                name: 'Last Calibration',
                                type: 'date',
                                icon: 'fa-calendar-check',
                                value: formatDateForInput(new Date())
                            },
                            {
                                name: 'Resolution',
                                type: 'text',
                                icon: 'fa-compress-arrows-alt',
                                value: '1920x1080 HD'
                            }
                        ]
                    });
                    
                } else if (type === 'maintenance') {
                    setupCommonFields({
                        name: 'Hydraulic Press HP-500',
                        category: 'Application Equipment',
                        manufacturer: 'PressMax Industrial',
                        model: 'HP-500',
                        serial: 'PMI-2024-1456',
                        location: 'Production Floor, Section C',
                        maintenance: 'Weekly oil level check. Quarterly seal inspection. Annual full service.',
                        ageMonths: 10,
                        warrantyYears: 5,
                        colors: {
                            bg: '#fefce8',
                            text: '#422006',
                            accent: '#ca8a04'
                        },
                        layout: 'compact',
                        customFields: [
                            {
                                name: 'Max Pressure',
                                type: 'text',
                                icon: 'fa-tachometer-alt',
                                value: '500 tons'
                            },
                            {
                                name: 'Oil Type',
                                type: 'text',
                                icon: 'fa-oil-can',
                                value: 'HLP-46 Hydraulic'
                            },
                            {
                                name: 'Service Manual',
                                type: 'url',
                                icon: 'fa-file-pdf',
                                value: 'https://intranet.thaiparker.co.th/manuals/hp500'
                            }
                        ]
                    });
                    
                } else if (type === 'it') {
                    setupCommonFields({
                        name: 'Network Switch 48-Port',
                        category: 'IT Equipment',
                        manufacturer: 'Cisco',
                        model: 'C9300-48P',
                        serial: 'FDO2413Z1AB',
                        location: 'Server Room, Rack 3, Unit 24',
                        maintenance: 'Monthly firmware updates. Dust cleaning quarterly. UPS check annually.',
                        ageMonths: 12,
                        warrantyYears: 5,
                        colors: {
                            bg: '#ecfdf5',
                            text: '#134e4a',
                            accent: '#0d9488'
                        },
                        layout: 'standard',
                        customFields: [
                            {
                                name: 'IP Address',
                                type: 'text',
                                icon: 'fa-network-wired',
                                value: '10.10.50.1'
                            },
                            {
                                name: 'Managed By',
                                type: 'text',
                                icon: 'fa-user-shield',
                                value: 'IT Infrastructure Team'
                            },
                            {
                                name: 'Power Draw',
                                type: 'text',
                                icon: 'fa-plug',
                                value: '750W PoE+'
                            },
                            {
                                name: 'Documentation',
                                type: 'url',
                                icon: 'fa-file-code',
                                value: 'https://intranet.thaiparker.co.th/it/network/switches'
                            }
                        ]
                    });
                }
                
                // Update validation icons
                document.querySelectorAll('[required]').forEach(field => {
                    if (field.value.trim()) {
                        field.classList.remove('border-red-500');
                        
                        // Clear validation error
                        const errorSpan = field.parentNode.nextElementSibling;
                        if (errorSpan && errorSpan.classList.contains('form-error')) {
                            errorSpan.textContent = '';
                        }
                        
                        // Show validation success icon
                        const validIcon = field.parentNode.querySelector('.validation-icon');
                        if (validIcon) {
                            validIcon.classList.remove('hidden');
                        }
                    }
                });
                
                // Update preview
                updateTagPreview();
            }
            
            // Update tag preview on form input
            function updateTagPreview() {
                const bgColor = document.getElementById('BackgroundColor').value || '#ffffff';
                const textColor = document.getElementById('TextColor').value || '#000000';
                const accentColor = document.getElementById('AccentColor').value || '#0284c7';
                
                const name = document.getElementById('ProductName').value || 'Product Name';
                const category = document.getElementById('Category').value || 'Product Category';
                const manufacturer = document.getElementById('Manufacturer').value || 'Manufacturer';
                const model = document.getElementById('ModelNumber').value || 'MODEL-XXX';
                const serial = document.getElementById('SerialNumber').value || 'SN12345';
                const location = document.getElementById('Location').value || 'Storage Location';
                const maintenance = document.getElementById('MaintenanceInfo').value || 'Maintenance information';
                
                // Handle dates
                let mfgDate = 'Jan 1, 2025';
                if (document.getElementById('ManufactureDate').value) {
                    mfgDate = formatDate(document.getElementById('ManufactureDate').value);
                }
                
                let purchaseDate = 'Jan 1, 2025';
                if (document.getElementById('PurchaseDate').value) {
                    purchaseDate = formatDate(document.getElementById('PurchaseDate').value);
                }
                
                let warrantyDate = 'Jan 1, 2026';
                if (document.getElementById('WarrantyExpiration').value) {
                    warrantyDate = formatDate(document.getElementById('WarrantyExpiration').value);
                }
                
                // Update preview elements
                const preview = document.getElementById('tag-preview');
                if (preview) {
                    preview.style.backgroundColor = bgColor;
                    preview.style.color = textColor;
                    
                    // Get active layout
                    const activeLayout = document.querySelector('.layout-option.active');
                    const layoutType = activeLayout ? activeLayout.getAttribute('data-layout') : 'standard';
                    
                    // For standard layout, update individual elements
                    if (layoutType === 'standard') {
                        const content = preview.querySelector('div');
                        if (content) {
                            content.className = 'p-6 h-full flex flex-col';
                            content.innerHTML = `
                                <div class="mb-4">
                                    <span id="preview-category" class="px-2 py-1 text-xs font-semibold rounded-full" style="background-color: ${accentColor}; color: ${bgColor}">
                                        ${category}
                                    </span>
                                    <h3 id="preview-name" class="text-xl font-bold mt-2" style="color: ${accentColor}">${name}</h3>
                                    <p id="preview-manufacturer" class="text-md">${manufacturer}</p>
                                    <div class="flex items-center space-x-2 mt-1 text-sm">
                                        <span class="font-semibold">Model:</span>
                                        <span id="preview-model">${model}</span>
                                    </div>
                                    <div class="flex items-center space-x-2 text-sm">
                                        <span class="font-semibold">Serial:</span>
                                        <span id="preview-serial">${serial}</span>
                                    </div>
                                </div>
                                <div class="space-y-2 mt-2 text-sm">
                                    <p class="flex items-center">
                                        <i class="fas fa-map-marker-alt mr-3" style="color: ${accentColor}"></i>
                                        <span class="font-medium">Location:</span>&nbsp;<span id="preview-location">${location}</span>
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-calendar-day mr-3" style="color: ${accentColor}"></i>
                                        <span class="font-medium">Manufactured:</span>&nbsp;<span id="preview-mfgdate">${mfgDate}</span>
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-calendar-check mr-3" style="color: ${accentColor}"></i>
                                        <span class="font-medium">Warranty Until:</span>&nbsp;<span id="preview-warranty">${warrantyDate}</span>
                                    </p>
                                    <p class="flex items-center">
                                        <i class="fas fa-tools mr-3" style="color: ${accentColor}"></i>
                                        <span class="font-medium">Maintenance:</span>&nbsp;<span id="preview-maintenance">${maintenance}</span>
                                    </p>
                                    <div id="preview-custom-fields" class="space-y-2 border-t border-gray-100 pt-2 mt-2 ${customFields.length === 0 ? 'hidden' : ''}">
                                        <!-- Custom fields will be dynamically added here -->
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // Update custom fields
                    updateCustomFieldsPreview();
                    
                    // Update icons color
                    const icons = preview.querySelectorAll('i:not(.fa-qrcode)');
                    icons.forEach(icon => {
                        icon.style.color = accentColor;
                    });
                    
                    // Update QR code colors
                    const qrFgColor = document.getElementById('qr-fg-color').value;
                    const qrBgColor = document.getElementById('qr-bg-color').value;
                    
                    // Update QR code preview (in a real implementation, this would generate an actual QR code)
                    const qrPreview = document.querySelector('.qr-preview');
                    if (qrPreview) {
                        qrPreview.style.backgroundColor = qrBgColor;
                        const qrIcon = qrPreview.querySelector('.fa-qrcode');
                        if (qrIcon) {
                            qrIcon.style.color = qrFgColor;
                        }
                    }
                }
            }
            
            // Format date for display
            function formatDate(dateString) {
                if (!dateString) return '';
                
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }
            
            // Format date for input fields (YYYY-MM-DD)
            function formatDateForInput(date) {
                return date.toISOString().split('T')[0];
            }
            
            // Character counter
            window.countChars = function(input, counterId, maxLength) {
                const counter = document.getElementById(counterId);
                if (counter) {
                    counter.textContent = `${input.value.length}/${maxLength}`;
                    
                    if (input.value.length > maxLength * 0.8) {
                        counter.classList.add('text-orange-500');
                    } else {
                        counter.classList.remove('text-orange-500');
                    }
                    
                    if (input.value.length >= maxLength) {
                        counter.classList.add('text-red-500');
                        counter.classList.remove('text-orange-500');
                    } else {
                        counter.classList.remove('text-red-500');
                    }
                }
            };
            
            // Form validation on submit
            document.getElementById('product-form').addEventListener('submit', function(e) {
                e.preventDefault(); // In this demo, we prevent form submission
                
                let isValid = true;
                const requiredFields = this.querySelectorAll('[required]');
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('border-red-500');
                        
                        // Show validation error
                        const errorSpan = field.parentNode.nextElementSibling;
                        if (errorSpan && errorSpan.classList.contains('form-error')) {
                            errorSpan.textContent = 'This field is required';
                        }
                    }
                });
                
                if (!isValid) {
                    // Find which step has errors
                    let stepWithError = 1;
                    const step1Errors = document.querySelectorAll('.form-section[data-step="1"] .border-red-500').length > 0;
                    const step2Errors = document.querySelectorAll('.form-section[data-step="2"] .border-red-500').length > 0;
                    
                    if (step1Errors) {
                        stepWithError = 1;
                    } else if (step2Errors) {
                        stepWithError = 2;
                    }
                    
                    // Go to the step with errors
                    window.goToStep(stepWithError);
                    
                    // Focus first invalid field
                    const firstInvalid = document.querySelector(`.form-section[data-step="${stepWithError}"] .border-red-500`);
                    if (firstInvalid) {
                        firstInvalid.focus();
                    }
                    
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                // Success notification for demo purposes
                showNotification('Product tag created successfully! In a real app, this would save to database.', 'success');
            });
        });
        
        // Show notification function
        function showNotification(message, type = 'success') {
            // Check if notification container exists
            let notificationContainer = document.getElementById('notification-container');
            
            if (!notificationContainer) {
                // Create notification container
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.className = 'fixed top-4 right-4 z-50 flex flex-col gap-2';
                document.body.appendChild(notificationContainer);
            }
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = 'transform transition-all duration-300 translate-x-full opacity-0 flex items-center gap-2 bg-white p-3 rounded-lg shadow-lg border max-w-md';
            
            // Set notification type
            if (type === 'success') {
                notification.classList.add('border-green-200');
                notification.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                        <i class="fas fa-check text-green-500"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="text-gray-800">${message}</p>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600" onclick="this.parentNode.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else if (type === 'error') {
                notification.classList.add('border-red-200');
                notification.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="text-gray-800">${message}</p>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600" onclick="this.parentNode.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else {
                notification.classList.add('border-blue-200');
                notification.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-info-circle text-blue-500"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="text-gray-800">${message}</p>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600" onclick="this.parentNode.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            // Add notification to container
            notificationContainer.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 10);
            
            // Automatically remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }
    </script>
}