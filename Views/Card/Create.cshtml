@model CardTagManager.Models.Card

@{
    ViewData["Title"] = "Create New Product";
}

<div class="mb-6">
    <a asp-action="Index" class="inline-flex items-center text-primary-600 hover:text-primary-700 transition-colors group">
        <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i> Back to Library
    </a>
</div>

<!-- Form Progress Indicator -->
<div class="form-progress mb-6">
    <div class="flex items-center justify-between max-w-2xl mx-auto">
        <div class="step active" data-step="1">
            <div class="step-circle bg-primary-600 text-white h-8 w-8 rounded-full flex items-center justify-center shadow-sm">1</div>
            <div class="step-label text-sm font-medium mt-1">Basic Info</div>
        </div>
        <div class="step-connector h-1 flex-grow bg-gray-200 mx-2 relative">
            <div class="absolute inset-0 bg-primary-600 step-progress" style="width: 0%"></div>
        </div>
        <div class="step" data-step="2">
            <div class="step-circle bg-gray-200 text-gray-600 h-8 w-8 rounded-full flex items-center justify-center shadow-sm">2</div>
            <div class="step-label text-sm font-medium mt-1">Details</div>
        </div>
        <div class="step-connector h-1 flex-grow bg-gray-200 mx-2 relative">
            <div class="absolute inset-0 bg-primary-600 step-progress" style="width: 0%"></div>
        </div>
        <div class="step" data-step="3">
            <div class="step-circle bg-gray-200 text-gray-600 h-8 w-8 rounded-full flex items-center justify-center shadow-sm">3</div>
            <div class="step-label text-sm font-medium mt-1">Appearance</div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-5 gap-8 fade-in">
    <!-- Form Section (3 columns) -->
    <div class="lg:col-span-3">
        <div class="card">
            <div class="card-header">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-plus-circle text-primary-500 mr-2"></i> Add New Product
                </h2>
                <p class="text-sm text-gray-500 mt-1">Fill in the details for your product tag</p>
            </div>
            
            <!-- Template Gallery -->
            <div class="px-6 pt-4 pb-2">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-medium text-gray-700 flex items-center">
                        <i class="fas fa-th-large text-primary-400 mr-2"></i> 
                        Template Library
                        <span class="ml-2 px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">Quick Start</span>
                    </h3>
                    <button type="button" id="create-template-btn" class="text-sm inline-flex items-center text-primary-600 hover:text-primary-700 px-2 py-1 rounded hover:bg-primary-50 transition-all">
                        <i class="fas fa-plus-circle mr-1"></i> New Template
                    </button>
                </div>
                
                <!-- Template Categories Tabs -->
                <div class="template-tabs flex border-b border-gray-200 mb-3 overflow-x-auto pb-1 scrollbar-hide">
                    <button type="button" class="template-tab active whitespace-nowrap px-3 py-1.5 text-sm font-medium border-b-2 border-primary-500 text-primary-600" data-category="all">All Templates</button>
                    <!-- Dynamic categories will be inserted here -->
                </div>
                
                <!-- Search Templates -->
                <div class="mb-3">
                    <div class="relative">
                        <input type="text" id="template-search" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm transition-colors" placeholder="Search templates...">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Templates Container (Dynamic) -->
                <div id="template-container" class="grid grid-cols-3 gap-3 mb-4">
                    <!-- Templates will be loaded dynamically from API -->
                </div>
                
                <!-- Expanded Templates Container (Dynamic) -->
                <div id="expanded-template-container" class="grid grid-cols-3 gap-3 mb-4 hidden">
                    <!-- More templates will be loaded dynamically from API -->
                </div>
                
                <!-- Load More Button -->
                <div class="text-center mt-2 mb-4">
                    <button type="button" id="load-more-templates" class="text-sm text-primary-600 hover:text-primary-700 px-3 py-1 border border-primary-200 rounded-full hover:bg-primary-50 transition-all">
                        <span class="load-more-text"><i class="fas fa-chevron-down mr-1"></i> Load More Templates</span>
                        <span class="show-less-text hidden"><i class="fas fa-chevron-up mr-1"></i> Show Less</span>
                    </button>
                </div>
                
                <!-- Recently Used Templates -->
                <div class="recently-used mt-2 mb-3">
                    <h4 class="text-xs uppercase text-gray-500 font-medium mb-2">Recently Used</h4>
                    <div class="flex flex-wrap gap-2" id="recently-used-templates">
                        <!-- Recently used templates will be loaded dynamically -->
                    </div>
                </div>
            </div>
            
        <form asp-action="Create" method="post" id="product-form" enctype="multipart/form-data">
            <!-- Add hidden fields for QR colors and template type -->
            <input type="hidden" name="QrFgColor" id="qrFgColorHidden" value="#000000" />
            <input type="hidden" name="QrBgColor" id="qrBgColorHidden" value="#FFFFFF" />
            <input type="hidden" name="TemplateType" id="templateTypeHidden" value="" />
                <div class="card-body">
                    <!-- Step 1: Basic Information -->
                    <div class="form-section" data-step="1">
                        <h3 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b flex items-center">
                            <i class="fas fa-info-circle text-primary-400 mr-2"></i> Basic Information
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="form-group">
                                    <label asp-for="ProductName" class="form-label flex items-center">
                                        Product Name
                                        <span class="text-red-500 ml-1">*</span>
                                        <span class="ml-auto text-xs text-gray-400" id="name-counter">0/100</span>
                                    </label>
                                    <div class="relative">
                                        <input asp-for="ProductName" class="form-input pl-9" required 
                                               placeholder="RustShield Pro 5000" maxlength="100"
                                               oninput="countChars(this, 'name-counter', 100)">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-tag text-gray-400"></i>
                                        </div>
                                        <div class="validation-icon absolute inset-y-0 right-3 flex items-center hidden" id="name-valid">
                                            <i class="fas fa-check-circle text-green-500"></i>
                                        </div>
                                    </div>
                                    <span asp-validation-for="ProductName" class="form-error"></span>
                                </div>
                                
                                <div class="form-group">
                                    <label asp-for="Category" class="form-label">
                                        Category
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">
                                        <input asp-for="Category" class="form-input pl-9" id="Category" readonly placeholder="Auto-populated from template" required>
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-folder text-gray-400"></i>
                                        </div>
                                    </div>
                                    <span asp-validation-for="Category" class="form-error"></span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Product Image</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors cursor-pointer group" id="dropzone">
                                        <input type="file" class="hidden" id="product-image" name="ImageFile" accept="image/*">
                                        <div class="flex flex-col items-center justify-center">
                                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2 group-hover:text-primary-400 transition-colors"></i>
                                            <p class="text-sm text-gray-500 mb-1">Drag and drop an image here or click to browse</p>
                                            <p class="text-xs text-gray-400">PNG, JPG up to 5MB</p>
                                        </div>
                                    </div>
                                    <div id="image-preview" class="hidden mt-2">
                                        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-2">
                                            <div class="flex items-center">
                                                <img src="" alt="Preview" class="w-10 h-10 object-cover rounded mr-2 border border-gray-200">
                                                <span class="text-sm text-gray-700 truncate max-w-[180px] filename">filename.jpg</span>
                                            </div>
                                            <button type="button" class="text-red-500 hover:text-red-700 p-1 hover:bg-red-50 rounded transition-colors" id="remove-image">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4" id="template-fields-container">
                                <!-- Template-specific fields will be added here dynamically -->
                                <div class="p-4 bg-gray-50 rounded-lg text-center relative overflow-hidden">
                                    <div class="absolute inset-0 bg-gray-200 opacity-10 pattern-dots"></div>
                                    <i class="fas fa-arrow-left text-gray-400 text-2xl mb-2"></i>
                                    <p class="text-gray-600">Select a template to see additional fields</p>
                                    <div class="mt-2 text-sm text-gray-500">
                                        <p>Templates will pre-fill fields based on product type</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dynamic Custom Fields Container -->
                        <div id="custom-fields-container" class="mt-4 pt-4 border-t border-gray-200">
                            <!-- Custom fields will be inserted here -->
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button type="button" class="btn-primary next-step shadow-sm" data-next="2">
                                Continue to Details <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Product Details -->
                    <div class="form-section hidden" data-step="2">
                        <h3 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b flex items-center">
                            <i class="fas fa-clipboard-list text-primary-400 mr-2"></i> Product Details
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="form-group">
                                <label asp-for="Location" class="form-label">Location</label>
                                <div class="relative">
                                    <input asp-for="Location" class="form-input pl-9" placeholder="Chemical Storage Room A">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-map-marker-alt text-gray-400"></i>
                                    </div>
                                </div>
                                <span asp-validation-for="Location" class="form-error"></span>
                            </div>
                            
                            <!-- Chemical Storage Conditions (Only for chemical products) -->
                            <div class="form-group field-group chemical-field" style="display: none;">
                                <label for="StorageConditions" class="form-label flex items-center">
                                    Storage Conditions
                                    <span class="ml-2 px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">Chemical Only</span>
                                </label>
                                <div class="relative">
                                    <textarea id="StorageConditions" name="StorageConditions" class="form-input h-20 pl-9" 
                                              placeholder="Store at 10-15°C, away from direct sunlight, in a well-ventilated area"></textarea>
                                    <div class="absolute top-3 left-0 pl-3 flex items-start pointer-events-none">
                                        <i class="fas fa-temperature-low text-gray-400"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Design Dimensions (Only for design templates) -->
                            <div class="form-group field-group design-field" style="display: none;">
                                <label for="Dimensions" class="form-label flex items-center">
                                    Dimensions
                                    <span class="ml-2 px-2 py-0.5 bg-red-50 text-red-600 text-xs rounded-full">Design Only</span>
                                </label>
                                <div class="relative">
                                    <input type="text" id="Dimensions" name="Dimensions" class="form-input pl-9" 
                                          placeholder="1920x1080px, 300DPI">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-ruler-combined text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label asp-for="MaintenanceInfo" class="form-label">Maintenance Information</label>
                                <div class="relative">
                                    <textarea asp-for="MaintenanceInfo" class="form-input h-20 pl-9" 
                                              placeholder="Regular maintenance requirements and recommendations"></textarea>
                                    <div class="absolute top-3 left-0 pl-3 flex items-start pointer-events-none">
                                        <i class="fas fa-wrench text-gray-400"></i>
                                    </div>
                                </div>
                                <span asp-validation-for="MaintenanceInfo" class="form-error"></span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="form-group">
                                <label asp-for="ManufactureDate" class="form-label">
                                    Manufacture Date
                                    <span class="text-red-500 ml-1">*</span>
                                </label>
                                <div class="relative">
                                    <input asp-for="ManufactureDate" type="date" class="form-input pl-9" required value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-calendar-day text-gray-400"></i>
                                    </div>
                                </div>
                                <span asp-validation-for="ManufactureDate" class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label asp-for="PurchaseDate" class="form-label">
                                    Purchase Date
                                    <span class="text-red-500 ml-1">*</span>
                                </label>
                                <div class="relative">
                                    <input asp-for="PurchaseDate" type="date" class="form-input pl-9" required value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-shopping-cart text-gray-400"></i>
                                    </div>
                                </div>
                                <span asp-validation-for="PurchaseDate" class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label asp-for="WarrantyExpiration" class="form-label warranty-label">
                                    Warranty Until
                                    <span class="text-red-500 ml-1">*</span>
                                </label>
                                <div class="relative">
                                    <input asp-for="WarrantyExpiration" type="date" class="form-input pl-9 warranty-input" required value="@DateTime.Now.AddYears(1).ToString("yyyy-MM-dd")">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-shield-alt text-gray-400"></i>
                                    </div>
                                </div>
                                <span asp-validation-for="WarrantyExpiration" class="form-error"></span>
                            </div>
                        </div>

                        <!-- License field (Only for design templates) -->
                        <div class="form-group field-group design-field mt-4" style="display: none;">
                            <label for="LicenseInfo" class="form-label flex items-center">
                                License Information
                                <span class="ml-2 px-2 py-0.5 bg-red-50 text-red-600 text-xs rounded-full">Design Only</span>
                            </label>
                            <div class="relative">
                                <select id="LicenseInfo" name="LicenseInfo" class="form-input pl-9">
                                    <option value="Internal Use Only">Internal Use Only</option>
                                    <option value="Company Licensed">Company Licensed</option>
                                    <option value="Perpetual License">Perpetual License</option>
                                    <option value="Royalty Free">Royalty Free</option>
                                    <option value="Rights Managed">Rights Managed</option>
                                </select>
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-copyright text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button type="button" class="btn-secondary prev-step shadow-sm" data-prev="1">
                                <i class="fas fa-arrow-left mr-2"></i> Back to Basic Info
                            </button>
                            <button type="button" class="btn-primary next-step shadow-sm" data-next="3">
                                Continue to Appearance <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Appearance -->
                    <div class="form-section hidden" data-step="3">
                        <h3 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b flex items-center">
                            <i class="fas fa-palette text-primary-400 mr-2"></i> Card Appearance
                        </h3>
                        
                        <div class="mb-6">
                            <label class="form-label">Card Layout</label>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="layout-option border rounded-lg p-2 cursor-pointer hover:border-primary-500 hover:shadow-md transition-all active" data-layout="standard">
                                    <input type="hidden" name="Layout" id="layoutHidden" value="standard" />
                                    <div class="bg-gray-50 rounded mb-1 flex items-center justify-center p-3">
                                        <div class="w-full aspect-w-16 aspect-h-10 bg-white rounded shadow-sm p-1">
                                            <div class="flex">
                                                <div class="flex-grow">
                                                    <div class="w-1/2 h-2 bg-gray-300 rounded mb-1"></div>
                                                    <div class="w-3/4 h-1 bg-gray-300 rounded mb-2"></div>
                                                    <div class="space-y-1">
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                    </div>
                                                </div>
                                                <div class="w-1/4 flex items-center justify-center">
                                                    <div class="w-10 h-10 bg-gray-300 rounded"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-center font-medium">Standard</p>
                                </div>
                                <div class="layout-option border rounded-lg p-2 cursor-pointer hover:border-primary-500 hover:shadow-md transition-all" data-layout="modern">
                                    <div class="bg-gray-50 rounded mb-1 flex items-center justify-center p-3">
                                        <div class="w-full aspect-w-16 aspect-h-10 bg-white rounded shadow-sm p-1">
                                            <div class="flex flex-col">
                                                <div class="h-1/3 w-full bg-gray-300 rounded-t"></div>
                                                <div class="p-1 flex">
                                                    <div class="flex-grow">
                                                        <div class="w-1/2 h-1 bg-gray-300 rounded mb-1"></div>
                                                        <div class="space-y-1">
                                                            <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                            <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                        </div>
                                                    </div>
                                                    <div class="w-1/4 flex items-center justify-center">
                                                        <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-center font-medium">Modern</p>
                                </div>
                                <div class="layout-option border rounded-lg p-2 cursor-pointer hover:border-primary-500 hover:shadow-md transition-all" data-layout="compact">
                                    <div class="bg-gray-50 rounded mb-1 flex items-center justify-center p-3">
                                        <div class="w-full aspect-w-16 aspect-h-10 bg-white rounded shadow-sm p-1">
                                            <div class="flex">
                                                <div class="flex-grow p-1">
                                                    <div class="w-3/4 h-2 bg-gray-300 rounded mb-1"></div>
                                                    <div class="space-y-1 mt-1">
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                        <div class="w-full h-1 bg-gray-300 rounded"></div>
                                                    </div>
                                                </div>
                                                <div class="w-1/3 bg-gray-200 rounded-r flex items-center justify-center">
                                                    <div class="w-8 h-8 bg-gray-300 rounded"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-center font-medium">Compact</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="form-group">
                                <label asp-for="BackgroundColor" class="form-label">Background Color</label>
                                <div class="color-picker-wrapper">
                                <div class="flex">
                                    <input asp-for="BackgroundColor" type="color" class="color-input hidden" id="bg-color-picker">
                                    <div class="color-preview w-10 h-10 border border-gray-300 rounded-lg shadow-inner cursor-pointer" id="bg-color-preview" style="background-color: #ffffff"></div>
                                    <input asp-for="BackgroundColor" type="text" class="form-input ml-2 flex-grow" placeholder="#ffffff" value="#ffffff">
                                </div>
                                    <div class="color-presets mt-2 flex flex-wrap gap-2">
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#ffffff" style="background-color: #ffffff;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#f8fafc" style="background-color: #f8fafc;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#f0f9ff" style="background-color: #f0f9ff;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#1e293b" style="background-color: #1e293b;"></span>
                                    </div>
                                </div>
                                <span asp-validation-for="BackgroundColor" class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label asp-for="TextColor" class="form-label">Text Color</label>
                                <div class="color-picker-wrapper">
                                    <div class="flex">
                                        <input type="color" class="color-input w-10 h-10 border border-gray-300 rounded-lg shadow-inner cursor-pointer" id="text-color-picker" value="#000000">
                                        <input asp-for="TextColor" type="text" class="form-input ml-2 flex-grow" placeholder="#000000" value="#000000">
                                    </div>
                                    <div class="color-presets mt-2 flex flex-wrap gap-2">
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#000000" style="background-color: #000000;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#1e293b" style="background-color: #1e293b;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#ffffff" style="background-color: #ffffff;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#64748b" style="background-color: #64748b;"></span>
                                    </div>
                                </div>
                                <span asp-validation-for="TextColor" class="form-error"></span>
                            </div>
                            
                            <div class="form-group">
                                <label asp-for="AccentColor" class="form-label">Accent Color</label>
                                <div class="color-picker-wrapper">
                                    <div class="flex">
                                        <input type="color" class="color-input w-10 h-10 border border-gray-300 rounded-lg shadow-inner cursor-pointer" id="accent-color-picker" value="#0284c7">
                                        <input asp-for="AccentColor" type="text" class="form-input ml-2 flex-grow" placeholder="#0284c7" value="#0284c7">
                                    </div>
                                    <div class="color-presets mt-2 flex flex-wrap gap-2">
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#0284c7" style="background-color: #0284c7;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#f97316" style="background-color: #f97316;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#16a34a" style="background-color: #16a34a;"></span>
                                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#9333ea" style="background-color: #9333ea;"></span>
                                    </div>
                                </div>
                                <span asp-validation-for="AccentColor" class="form-error"></span>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-100">
                            <h4 class="text-sm font-medium mb-3 flex items-center">
                                <i class="fas fa-qrcode text-primary-400 mr-2"></i> QR Code Options
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1">Foreground Color</label>
                                    <div class="flex">
                                        <input type="color" class="w-10 h-10 border border-gray-300 rounded-lg cursor-pointer" value="#000000" id="qr-fg-color">
                                        <input type="text" class="form-input ml-2 flex-grow text-sm" value="#000000" id="qr-fg-color-text">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1">Background Color</label>
                                    <div class="flex">
                                        <input type="color" class="w-10 h-10 border border-gray-300 rounded-lg cursor-pointer" value="#ffffff" id="qr-bg-color">
                                        <input type="text" class="form-input ml-2 flex-grow text-sm" value="#ffffff" id="qr-bg-color-text">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button type="button" class="btn-secondary prev-step shadow-sm" data-prev="2">
                                <i class="fas fa-arrow-left mr-2"></i> Back to Details
                            </button>
                            <button type="submit" class="btn-primary relative group shadow-sm">
                                <span class="flex items-center">
                                    <i class="fas fa-save mr-2"></i> Create Product
                                </span>
                                <span class="absolute inset-0 flex items-center justify-center bg-primary-600 rounded-md opacity-0 transition-opacity group-hover:opacity-0 group-active:opacity-100">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <span class="text-red-500">*</span> Required fields
                        </div>
                        <div class="text-sm text-gray-500">
                            <span class="step-indicator">Step 1 of 3</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Preview Section (2 columns) -->
    <div class="lg:col-span-2">
        <div class="sticky top-6 space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-eye text-primary-500 mr-2"></i> Live Preview
                </h3>
                <div class="preview-controls flex gap-2">
                    <button type="button" class="text-sm text-gray-600 hover:text-gray-800 flex items-center p-1 hover:bg-gray-100 rounded transition-colors" id="rotate-preview">
                        <i class="fas fa-sync-alt mr-1"></i> Flip Card
                    </button>
                </div>
            </div>
            
<div class="card shadow-lg transition-all duration-300" id="card-preview-container">
                <div class="card-flip-container">
                    <!-- Front of card -->
                    <div class="business-card card-side card-front" id="tag-preview" style="background-color: #ffffff; color: #000000">
                        <div class="p-6 h-full flex flex-col relative">
                            <!-- Template indicator badge -->
                            <div class="absolute -top-8 right-0 transform translate-y-12 transition-transform duration-300 opacity-70 hover:opacity-100">
                                <div class="template-badge px-2 py-1 bg-white text-primary-600 text-xs font-medium rounded-t-lg shadow-sm">
                                    <i id="preview-template-icon" class="fas fa-flask mr-1"></i>
                                    <span id="preview-template-name">No Template</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <span id="preview-category" class="px-2 py-1 text-xs font-semibold rounded-full inline-block" style="background-color: #0284c7; color: #ffffff">
                                    Rust Coating Chemical
                                </span>
                                <h3 id="preview-name" class="text-xl font-bold mt-2" style="color: #0284c7">Product Name</h3>
                                <p id="preview-manufacturer" class="text-md">Manufacturer</p>
                                <div id="preview-custom-fields" class="mt-2 text-sm"></div>
                            </div>
                            <div class="space-y-2 mt-auto text-sm">
                                <p class="flex items-center">
                                    <i class="fas fa-map-marker-alt mr-3" style="color: #0284c7"></i>
                                    <span class="font-medium">Location:</span>&nbsp;<span id="preview-location">Not specified</span>
                                </p>
                                <p class="flex items-center">
                                    <i class="fas fa-calendar-day mr-3" style="color: #0284c7"></i>
                                    <span class="font-medium">Manufactured:</span>&nbsp;<span id="preview-mfgdate">@DateTime.Now.ToString("MM/dd/yyyy")</span>
                                </p>
                                <p class="flex items-center warranty-preview">
                                    <i class="fas fa-shield-alt mr-3" style="color: #0284c7"></i>
                                    <span class="font-medium">Warranty Until:</span>&nbsp;<span id="preview-warranty">@DateTime.Now.AddYears(1).ToString("MM/dd/yyyy")</span>
                                </p>
                                <p class="flex items-center">
                                    <i class="fas fa-wrench mr-3" style="color: #0284c7"></i>
                                    <span class="font-medium">Maintenance:</span>&nbsp;<span id="preview-maintenance">No maintenance info</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Back of card (QR Code) -->
                    <div class="business-card card-side card-back" style="background-color: #ffffff;">
                        <div class="p-6 h-full flex flex-col items-center justify-center">
                            <div class="qr-preview p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                                <div class="w-40 h-40 bg-white flex items-center justify-center rounded" id="card-qr-code-display">
                                    <i class="fas fa-qrcode text-gray-400 text-4xl"></i>
                                </div>
                                <p class="text-center text-sm mt-2 text-gray-700 font-medium" id="qr-product-name">Product Name</p>
                                <p class="text-center text-xs mt-1 text-gray-500">Scan for product details</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded shadow-sm">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Tips for effective product tags</h3>
                        <ul class="mt-2 text-sm text-blue-700 list-disc list-inside">
                            <li>Use clear, descriptive product names</li>
                            <li>Keep maintenance information concise and specific</li>
                            <li>Choose contrasting colors for better readability</li>
                            <li>Always include current location information</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div id="create-template-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 relative z-10 transform transition-all duration-300 opacity-0 scale-95">
        <div class="p-5 border-b border-gray-200 bg-gradient-to-r from-blue-500 to-primary-500 rounded-t-lg">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-white" id="template-modal-title">Create New Template</h3>
                <button type="button" class="text-white hover:text-gray-200 focus:outline-none" id="close-template-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-5 max-h-[70vh] overflow-y-auto">
            <form id="template-form" class="space-y-4">
                <input type="hidden" id="template-edit-id" value="" />
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Template Name <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="text" id="template-name" class="form-input pl-9" placeholder="E.g., Laboratory Equipment" required>
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-bookmark text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="text" id="template-category" class="form-input pl-9" placeholder="E.g., Lab Equipment" required>
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-folder text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Icon Selection <span class="text-red-500">*</span></label>
                    <div class="grid grid-cols-4 md:grid-cols-6 gap-3 mt-1">
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all active" data-icon="flask">
                            <i class="fas fa-flask text-primary-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="microscope">
                            <i class="fas fa-microscope text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="vial">
                            <i class="fas fa-vial text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="laptop">
                            <i class="fas fa-laptop text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="file-alt">
                            <i class="fas fa-file-alt text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="shield-alt">
                            <i class="fas fa-shield-alt text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="cogs">
                            <i class="fas fa-cogs text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="tools">
                            <i class="fas fa-tools text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="box">
                            <i class="fas fa-box text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="globe">
                            <i class="fas fa-globe text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="bolt">
                            <i class="fas fa-bolt text-gray-500 text-2xl"></i>
                        </div>
                        <div class="icon-option border rounded-lg p-3 flex items-center justify-center cursor-pointer hover:border-primary-500 hover:shadow-sm transition-all" data-icon="cube">
                            <i class="fas fa-cube text-gray-500 text-2xl"></i>
                        </div>
                    </div>
                    <input type="hidden" id="template-icon" value="flask">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Background Color</label>
                    <div class="flex">
                        <input type="color" id="template-bg-color" class="w-10 h-10 border border-gray-300 rounded-lg cursor-pointer" value="#f0f9ff">
                        <input type="text" id="template-bg-color-text" class="form-input ml-2 flex-grow" value="#f0f9ff">
                    </div>
                    <div class="color-presets mt-2 flex flex-wrap gap-2">
                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#f0f9ff" style="background-color: #f0f9ff;"></span>
                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#f0fdf4" style="background-color: #f0fdf4;"></span>
                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#fef3c7" style="background-color: #fef3c7;"></span>
                        <span class="color-preset w-6 h-6 rounded-full border border-gray-200 shadow-sm cursor-pointer hover:scale-110 transition-transform" data-color="#fdf2f8" style="background-color: #fdf2f8;"></span>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-semibold text-gray-700 flex items-center">
                            <i class="fas fa-layer-group text-primary-400 mr-2"></i> Custom Fields
                        </h4>
                        <button type="button" id="add-field-btn" class="text-sm inline-flex items-center text-primary-600 hover:text-primary-700 px-2 py-1 rounded hover:bg-blue-50 transition-colors">
                            <i class="fas fa-plus-circle mr-1"></i> Add Field
                        </button>
                    </div>
                    
                    <div id="custom-fields" class="space-y-4 max-h-[300px] overflow-y-auto pr-2">
                        <!-- Fields will be added here -->
                        <div class="custom-field-row flex items-start gap-2 p-3 border border-gray-100 rounded-lg bg-gray-50 hover:bg-white hover:shadow-sm transition-all">
                            <div class="flex-grow">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div class="form-group mb-2">
                                        <label class="form-label text-sm">Field Name <span class="text-red-500">*</span></label>
                                        <input type="text" class="form-input py-2 text-sm field-name" placeholder="E.g., Lab ID" required>
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="form-label text-sm">Field Type <span class="text-red-500">*</span></label>
                                        <select class="form-input py-2 text-sm field-type">
                                            <option value="text">Text</option>
                                            <option value="select">Dropdown</option>
                                            <option value="number">Number</option>
                                            <option value="date">Date</option>
                                            <option value="textarea">Text Area</option>
                                        </select>
                                    </div>
                                    <div class="form-group mb-2">
                                        <label class="form-label text-sm">Icon</label>
                                        <select class="form-input py-2 text-sm field-icon">
                                            <option value="tag">Tag</option>
                                            <option value="info-circle">Info</option>
                                            <option value="check-circle">Check</option>
                                            <option value="flag">Flag</option>
                                            <option value="clipboard">Clipboard</option>
                                            <option value="calendar">Calendar</option>
                                            <option value="user">User</option>
                                            <option value="link">Link</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="field-options hidden mt-2">
                                    <label class="form-label text-sm">Options (comma separated)</label>
                                    <input type="text" class="form-input py-2 text-sm field-options-input" placeholder="Option 1, Option 2, Option 3">
                                </div>
                                <div class="form-group mt-2">
                                    <label class="form-label text-sm">Placeholder</label>
                                    <input type="text" class="form-input py-2 text-sm field-placeholder" placeholder="Enter placeholder text">
                                </div>
                                <div class="form-group mt-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" class="field-required mr-2" id="field-required-checkbox" checked>
                                        <label for="field-required-checkbox" class="text-sm">Required</label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-shrink-0 mt-6">
                                <button type="button" class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full transition-colors remove-field-btn">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="p-5 border-t border-gray-200 bg-gray-50 flex justify-end rounded-b-lg">
            <button type="button" class="btn-secondary mr-2 shadow-sm" id="cancel-template-btn">
                Cancel
            </button>
            <button type="button" class="btn-danger mr-2 shadow-sm hidden" id="delete-template-btn">
                <i class="fas fa-trash mr-2"></i> Delete Template
            </button>
            <button type="button" class="btn-primary shadow-sm" id="save-template-btn">
                <i class="fas fa-save mr-2"></i> Save Template
            </button>
        </div>
    </div>
</div>

<!-- Delete Template Confirmation Modal -->
<div id="delete-template-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 relative z-10 transform transition-all duration-300 opacity-0 scale-95">
        <div class="p-5 border-b border-gray-200 bg-red-50">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-red-700 flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i> Delete Template
                </h3>
                <button type="button" class="text-gray-400 hover:text-gray-600 focus:outline-none" id="close-delete-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-5">
            <p class="text-gray-700">Are you sure you want to delete this template? This action cannot be undone.</p>
            <div class="mt-3 p-3 border border-red-100 rounded-lg bg-red-50">
                <p class="flex items-center text-red-600 font-medium">
                    <i class="fas fa-folder mr-2"></i>
                    <span id="delete-template-name"></span>
                </p>
            </div>
            <input type="hidden" id="delete-template-id" value="" />
        </div>
        <div class="p-5 border-t border-gray-200 bg-gray-50 flex justify-end">
            <button type="button" class="btn-secondary mr-2 shadow-sm" id="cancel-delete-btn">
                Cancel
            </button>
            <button type="button" class="btn-danger shadow-sm" id="confirm-delete-btn">
                <i class="fas fa-trash mr-2"></i> Delete
            </button>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div id="add-category-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 relative z-10 transform transition-all duration-300 opacity-0 scale-95">
        <div class="p-5 border-b border-gray-200 bg-gradient-to-r from-blue-500 to-primary-500 rounded-t-lg">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">Add New Category</h3>
                <button type="button" class="text-white hover:text-gray-200 focus:outline-none" id="close-category-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-5">
            <form id="category-form">
                <div class="form-group">
                    <label class="form-label">Category Name <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="new-category-name" class="form-input pl-9" placeholder="E.g., Laboratory Equipment" required>
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-folder text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="p-5 border-t border-gray-200 bg-gray-50 flex justify-end rounded-b-lg">
            <button type="button" class="btn-secondary mr-2 shadow-sm" id="cancel-category-btn">
                Cancel
            </button>
            <button type="button" class="btn-primary shadow-sm" id="save-category-btn">
                <i class="fas fa-save mr-2"></i> Save Category
            </button>
        </div>
    </div>
</div>

<!-- Template Applied Toast Notification -->
<div id="template-toast" class="fixed top-6 right-6 bg-white shadow-lg rounded-lg p-4 transform -translate-y-12 opacity-0 transition-all duration-300 z-50 max-w-sm border border-gray-100 hidden">
    <div class="flex items-center">
        <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-green-100 text-green-500 mr-3">
            <i class="fas fa-check"></i>
        </div>
        <div class="flex-grow">
            <p class="font-medium">Template Applied</p>
            <p class="text-sm text-gray-500" id="template-toast-message">Template has been applied successfully</p>
        </div>
        <button onclick="hideTemplateToast()" class="ml-2 text-gray-400 hover:text-gray-600 h-8 w-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

@section Scripts {
@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// Function to update QR color values to hidden fields
function updateQrColors() {
    document.getElementById('qrFgColorHidden').value = document.getElementById('qr-fg-color').value || '#000000';
    document.getElementById('qrBgColorHidden').value = document.getElementById('qr-bg-color').value || '#FFFFFF';
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    
    // Force create QRCode if not defined
    if (typeof QRCode === 'undefined') {
        console.warn('QRCode library not found, creating fallback...');
        // Simple QRCode fallback
        window.QRCode = function(element, options) {
            if (typeof element === 'string') {
                element = document.querySelector(element);
            }
            
            if (!element) {
                console.error('QRCode element not found');
                return;
            }
            
            // Just display a placeholder
            element.innerHTML = `
                <div style="width:160px;height:160px;display:flex;align-items:center;justify-content:center;border:1px solid #e5e7eb;background:#f9fafb;">
                    <div style="text-align:center;">
                        <i class="fas fa-qrcode text-gray-400" style="font-size:48px;margin-bottom:8px;"></i>
                        <div style="font-size:12px;color:#6b7280;">QR Code for:<br>${options.text}</div>
                    </div>
                </div>
            `;
            
            console.log('Fallback QR code displayed');
        };
        
        // Add correction levels
        QRCode.CorrectLevel = {L:1, M:0, Q:3, H:2};
    } else {
        console.log('QRCode library loaded successfully');
    }
    
    // Load all required initialization functions
    try {
        console.log('Initializing components...');
        initializeCategories(); // Load categories first
        initializeSteps();
        initializeColorPickers();
        initializeCardLayouts(); 
        initializeImageUpload();
        initializeTemplates(); // This will now call initializeTemplateTabs after templates are loaded
        initializeFieldVisibility();
        initializeTemplateModal();
        initializeLoadMoreTemplates();
    } catch (e) {
        console.error('Error during initialization:', e);
    }
    
    // Force preview containers to be visible
    const previewContainers = [
        'card-preview-container',
        'tag-preview',
        'card-qr-code-display'
    ];
    
    previewContainers.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = id === 'card-qr-code-display' ? 'flex' : 'block';
            if (id === 'card-preview-container') {
                element.style.minHeight = '400px';
                element.style.height = '400px';
            }
            console.log(`Force displayed ${id}`);
        } else {
            console.error(`Preview element not found: ${id}`);
        }
    });
    
    // Initialize preview with default values
    console.log('Updating preview...');
    try {
        updateTagPreview();
    } catch (e) {
        console.error('Error updating tag preview:', e);
    }
    
    // Generate QR code with delay to ensure rendering
    setTimeout(function() {
        try {
            console.log('Generating QR code...');
            generateQRCode();
        } catch (e) {
            console.error('Error generating QR code:', e);
            
            // Fallback QR display if generation fails
            const qrElement = document.getElementById('card-qr-code-display');
            if (qrElement) {
                qrElement.innerHTML = `
                    <div style="text-align:center;">
                        <i class="fas fa-qrcode text-gray-400" style="font-size:48px;"></i>
                        <div style="font-size:12px;color:#6b7280;margin-top:8px;">QR Code Preview</div>
                    </div>
                `;
            }
        }
    }, 500);
    
    // Force preview visibility after everything else
    setTimeout(function() {
        const cardFront = document.querySelector('.card-front');
        if (cardFront) cardFront.style.display = 'block';
        
        const cardBack = document.querySelector('.card-back');
        if (cardBack) cardBack.style.display = 'none';
        
        console.log('Final visibility enforcement complete');
    }, 800);

    // Initialize form submission
    document.getElementById('product-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Update QR colors before submission
        updateQrColors();
        
        // Validate form
        if (validateForm()) {
            saveCard();
        }
    });
    
    // Add input event listeners to all form fields for live preview updates
    document.querySelectorAll('input, textarea, select').forEach(input => {
        input.addEventListener('input', updateTagPreview);
        input.addEventListener('change', updateTagPreview);
    });
    
    // Add specific event listener for color pickers
    document.querySelectorAll('input[type="color"]').forEach(colorPicker => {
        colorPicker.addEventListener('input', function() {
            updateTagPreview();
            if (this.id === 'qr-fg-color' || this.id === 'qr-bg-color') {
                updateQrColors();
                generateQRCode();
            }
        });
    });
    
    // Initialize Load More Templates button
    function initializeLoadMoreTemplates() {
        const loadMoreBtn = document.getElementById('load-more-templates');
        const expandedContainer = document.getElementById('expanded-template-container');
        const loadMoreText = document.querySelector('.load-more-text');
        const showLessText = document.querySelector('.show-less-text');
        
        loadMoreBtn.addEventListener('click', function() {
            const isExpanded = !expandedContainer.classList.contains('hidden');
            
            if (isExpanded) {
                // Hide expanded templates
                expandedContainer.classList.add('hidden');
                loadMoreText.classList.remove('hidden');
                showLessText.classList.add('hidden');
            } else {
                // Show expanded templates
                expandedContainer.classList.remove('hidden');
                loadMoreText.classList.add('hidden');
                showLessText.classList.remove('hidden');
            }
        });
    }
    
    // Template toast functions
    window.showTemplateToast = function(templateName) {
        const toast = document.getElementById('template-toast');
        const message = document.getElementById('template-toast-message');
        
        message.textContent = `Template "${templateName}" has been applied successfully`;
        
        toast.classList.remove('hidden', '-translate-y-12', 'opacity-0');
        toast.classList.add('translate-y-0', 'opacity-100');
        
        setTimeout(hideTemplateToast, 3000);
    };
    
    window.hideTemplateToast = function() {
        const toast = document.getElementById('template-toast');
        toast.classList.remove('translate-y-0', 'opacity-100');
        toast.classList.add('-translate-y-12', 'opacity-0');
        
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 300);
    };
    
    // Validate entire form
    function validateForm() {
        let isValid = true;
        const requiredFields = document.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('border-red-500');
                isValid = false;
                
                // Show the appropriate step if there's an error
                const step = field.closest('.form-section');
                if (step && step.classList.contains('hidden')) {
                    const stepNumber = step.getAttribute('data-step');
                    showStep(parseInt(stepNumber));
                }
            } else {
                field.classList.remove('border-red-500');
            }
        });
        
        if (!isValid) {
            showNotification('Please fill in all required fields', 'error');
        }
        
        return isValid;
    }
    
    // Show a specific step
    function showStep(stepNumber) {
        const formSections = document.querySelectorAll('.form-section');
        formSections.forEach(section => {
            section.classList.add('hidden');
        });
        
        document.querySelector(`.form-section[data-step="${stepNumber}"]`).classList.remove('hidden');
        
        // Update step indicator
        document.querySelector('.step-indicator').textContent = `Step ${stepNumber} of 3`;
        
        // Update step circles
        const steps = document.querySelectorAll('.step');
        steps.forEach(step => {
            step.classList.remove('active');
        });
        
        document.querySelector(`.step[data-step="${stepNumber}"]`).classList.add('active');
        
        // Update form progress
        updateFormProgress(stepNumber);
    }
    
    // Save card data to local storage for testing
    function saveCard() {
        // Get form data for submission
        const form = document.getElementById('product-form');
        form.submit();
    }
    
    // Generate QR Code
    function generateQRCode() {
        const qrElement = document.getElementById('card-qr-code-display');
        if (!qrElement) {
            console.error('QR code container not found');
            return;
        }
        
        // Clear any existing QR code
        qrElement.innerHTML = '';
        
        const productName = document.getElementById('ProductName').value || 'Sample Product';
        const qrFgColor = document.getElementById('qr-fg-color').value || '#000000';
        const qrBgColor = document.getElementById('qr-bg-color').value || '#FFFFFF';
        
        // Update QR product name on back of card
        const qrProductNameElement = document.getElementById('qr-product-name');
        if (qrProductNameElement) {
            qrProductNameElement.textContent = productName;
        }
        
        // QR code data would typically contain a URL or ID to access the product details
        const qrData = `PRODUCT:${productName}:${Date.now()}`;
        
        try {
            // Make sure QRCode is loaded
            if (typeof QRCode === 'undefined') {
                throw new Error('QRCode library not loaded');
            }
            
            // Create new QR Code
            new QRCode(qrElement, {
                text: qrData,
                width: 160,
                height: 160,
                colorDark: qrFgColor,
                colorLight: qrBgColor,
                correctLevel: QRCode.CorrectLevel.H
            });
            
            console.log('QR code generated successfully');
        } catch (error) {
            console.error('Error generating QR code:', error);
            qrElement.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 text-xl"></i><p class="text-xs text-red-500 mt-2">Error generating QR code</p>';
        }
    }
    
    // QR code color change event listeners
    document.getElementById('qr-fg-color').addEventListener('input', function() {
        document.getElementById('qr-fg-color-text').value = this.value;
        updateQrColors();
        generateQRCode();
    });
    
    document.getElementById('qr-fg-color-text').addEventListener('input', function() {
        document.getElementById('qr-fg-color').value = this.value;
        updateQrColors();
        generateQRCode();
    });
    
    document.getElementById('qr-bg-color').addEventListener('input', function() {
        document.getElementById('qr-bg-color-text').value = this.value;
        updateQrColors();
        generateQRCode();
    });
    
    document.getElementById('qr-bg-color-text').addEventListener('input', function() {
        document.getElementById('qr-bg-color').value = this.value;
        updateQrColors();
        generateQRCode();
    });
    
    // Initialize template tabs
    function initializeTemplateTabs() {
        const templateTabs = document.querySelectorAll('.template-tab');
        const templateCards = document.querySelectorAll('.template-card');
        
        templateTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                templateTabs.forEach(t => {
                    t.classList.remove('active', 'border-primary-500', 'text-primary-600');
                    t.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Add active class to current tab
                this.classList.add('active', 'border-primary-500', 'text-primary-600');
                this.classList.remove('border-transparent', 'text-gray-500');
                
                // Show/hide cards based on category
                const category = this.getAttribute('data-category');
                
                templateCards.forEach(card => {
                    if (category === 'all' || card.getAttribute('data-category') === category) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });
        
        // Template search functionality
        const templateSearch = document.getElementById('template-search');
        if (templateSearch) {
            templateSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                templateCards.forEach(card => {
                    const cardText = card.textContent.toLowerCase();
                    
                    if (cardText.includes(searchTerm)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }
        
        // Template chip functionality (recently used)
        const templateChips = document.querySelectorAll('.template-chip');
        templateChips.forEach(chip => {
            chip.addEventListener('click', function() {
                const templateId = this.getAttribute('data-template');
                applyTemplate(templateId);
            });
        });
    }
    
    // Initialize field visibility based on template type
    function initializeFieldVisibility() {
        const templateType = document.getElementById('templateTypeHidden').value;
        if (templateType) {
            updateFieldVisibility(templateType);
        }
    }
    
    // Initialize steps functionality for multi-step form
    function initializeSteps() {
        const nextButtons = document.querySelectorAll('.next-step');
        const prevButtons = document.querySelectorAll('.prev-step');
        const formSections = document.querySelectorAll('.form-section');
        const stepIndicator = document.querySelector('.step-indicator');
        const steps = document.querySelectorAll('.step');
        const progressBars = document.querySelectorAll('.step-progress');
        
        // Handle next button clicks
        nextButtons.forEach(button => {
            button.addEventListener('click', function() {
                const currentStep = parseInt(this.getAttribute('data-next')) - 1;
                const nextStep = parseInt(this.getAttribute('data-next'));
                
                // Validate current step before proceeding
                if (validateStep(currentStep)) {
                    // Hide current section, show next section
                    formSections.forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    document.querySelector(`.form-section[data-step="${nextStep}"]`).classList.remove('hidden');
                    
                    // Update step indicator
                    stepIndicator.textContent = `Step ${nextStep} of 3`;
                    
                    // Update step circles
                    steps.forEach(step => {
                        step.classList.remove('active');
                    });
                    
                    document.querySelector(`.step[data-step="${nextStep}"]`).classList.add('active');
                    
                    // Update progress bars
                    for (let i = 0; i < nextStep - 1; i++) {
                        progressBars[i].style.width = '100%';
                    }
                    
                    // Update form progress
                    updateFormProgress(nextStep);
                    
                    // If moving to step 3, generate QR code preview
                    if (nextStep === 3) {
                        generateQRCode();
                    }
                    
                    // Scroll to top
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            });
        });
        
        // Handle previous button clicks
        prevButtons.forEach(button => {
            button.addEventListener('click', function() {
                const prevStep = parseInt(this.getAttribute('data-prev'));
                
                // Hide current section, show previous section
                formSections.forEach(section => {
                    section.classList.add('hidden');
                });
                
                document.querySelector(`.form-section[data-step="${prevStep}"]`).classList.remove('hidden');
                
                // Update step indicator
                stepIndicator.textContent = `Step ${prevStep} of 3`;
                
                // Update step circles
                steps.forEach(step => {
                    step.classList.remove('active');
                });
                
                document.querySelector(`.step[data-step="${prevStep}"]`).classList.add('active');
                
                // Update form progress
                updateFormProgress(prevStep);
                
                // Scroll to top
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        });
        
        // Validate step before proceeding
        function validateStep(stepNumber) {
            let isValid = true;
            const currentSection = document.querySelector(`.form-section[data-step="${stepNumber + 1}"]`);
            const requiredFields = currentSection.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('border-red-500');
                    isValid = false;
                } else {
                    field.classList.remove('border-red-500');
                }
            });
            
            if (!isValid) {
                // Show error notification
                showNotification('Please fill in all required fields', 'error');
                
                // Scroll to first invalid field
                const firstInvalidField = currentSection.querySelector('.border-red-500');
                if (firstInvalidField) {
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidField.focus();
                }
            }
            
            return isValid;
        }
        
        // Update form progress
        function updateFormProgress(step) {
            // Calculate progress percentage
            const progress = ((step - 1) / 2) * 100;
            
            // Update progress bars
            document.querySelectorAll('.step-progress').forEach((progressBar, index) => {
                if (index < step - 1) {
                    progressBar.style.width = '100%';
                } else {
                    progressBar.style.width = '0%';
                }
            });
            
            // Update step circles
            document.querySelectorAll('.step').forEach((stepCircle, index) => {
                const stepNumber = index + 1;
                
                if (stepNumber < step) {
                    // Completed step
                    stepCircle.classList.add('active');
                    stepCircle.querySelector('.step-circle').classList.remove('bg-gray-200', 'text-gray-600');
                    stepCircle.querySelector('.step-circle').classList.add('bg-primary-600', 'text-white');
                } else if (stepNumber === step) {
                    // Current step
                    stepCircle.classList.add('active');
                    stepCircle.querySelector('.step-circle').classList.remove('bg-gray-200', 'text-gray-600');
                    stepCircle.querySelector('.step-circle').classList.add('bg-primary-600', 'text-white');
                } else {
                    // Upcoming step
                    stepCircle.classList.remove('active');
                    stepCircle.querySelector('.step-circle').classList.remove('bg-primary-600', 'text-white');
                    stepCircle.querySelector('.step-circle').classList.add('bg-gray-200', 'text-gray-600');
                }
            });
        }
        
        // Character counter for name field
        window.countChars = function(input, counterId, maxLength) {
            const counter = document.getElementById(counterId);
            const length = input.value.length;
            counter.textContent = `${length}/${maxLength}`;
            
            // Show validation icon when field has a value
            const validIcon = document.getElementById('name-valid');
            if (length > 0) {
                validIcon.classList.remove('hidden');
            } else {
                validIcon.classList.add('hidden');
            }
            
            // Update preview and QR code
            updateTagPreview();
        };
    }
    
    // Initialize color pickers
    function initializeColorPickers() {
        // Background color
        const bgColorPicker = document.getElementById('bg-color-picker');
        const bgColorText = document.getElementById('BackgroundColor');
        const bgColorPreview = document.getElementById('bg-color-preview');
        
        // For the color picker that's hidden, we need to handle the preview div click
        bgColorPreview.addEventListener('click', function() {
            bgColorPicker.click();
        });
        
        bgColorPicker.addEventListener('input', function() {
            bgColorText.value = this.value;
            bgColorPreview.style.backgroundColor = this.value;
            updateTagPreview();
        });
        
        bgColorText.addEventListener('input', function() {
            try {
                bgColorPicker.value = this.value;
                bgColorPreview.style.backgroundColor = this.value;
                updateTagPreview();
            } catch (e) {
                // Invalid color value, ignore
            }
        });
        
        // Text color
        const textColorPicker = document.getElementById('text-color-picker');
        const textColorText = document.getElementById('TextColor');
        
        textColorPicker.addEventListener('input', function() {
            textColorText.value = this.value;
            updateTagPreview();
        });
        
        textColorText.addEventListener('input', function() {
            try {
                textColorPicker.value = this.value;
                updateTagPreview();
            } catch (e) {
                // Invalid color value, ignore
            }
        });
        
        // Accent color
        const accentColorPicker = document.getElementById('accent-color-picker');
        const accentColorText = document.getElementById('AccentColor');
        
        accentColorPicker.addEventListener('input', function() {
            accentColorText.value = this.value;
            updateTagPreview();
        });
        
        accentColorText.addEventListener('input', function() {
            try {
                accentColorPicker.value = this.value;
                updateTagPreview();
            } catch (e) {
                // Invalid color value, ignore
            }
        });
        
        // QR code colors
        const qrFgColor = document.getElementById('qr-fg-color');
        const qrFgColorText = document.getElementById('qr-fg-color-text');
        const qrBgColor = document.getElementById('qr-bg-color');
        const qrBgColorText = document.getElementById('qr-bg-color-text');
        
        qrFgColor.addEventListener('input', function() {
            qrFgColorText.value = this.value;
            updateQrColors();
            generateQRCode();
        });
        
        qrFgColorText.addEventListener('input', function() {
            try {
                qrFgColor.value = this.value;
                updateQrColors();
                generateQRCode();
            } catch (e) {
                // Invalid color value, ignore
            }
        });
        
        qrBgColor.addEventListener('input', function() {
            qrBgColorText.value = this.value;
            updateQrColors();
            generateQRCode();
        });
        
        qrBgColorText.addEventListener('input', function() {
            try {
                qrBgColor.value = this.value;
                updateQrColors();
                generateQRCode();
            } catch (e) {
                // Invalid color value, ignore
            }
        });
        
        // Color presets
        document.querySelectorAll('.color-preset').forEach(preset => {
            preset.addEventListener('click', function() {
                const color = this.getAttribute('data-color');
                const parent = this.closest('.color-picker-wrapper');
                
                if (parent) {
                    const colorInput = parent.querySelector('input[type="color"]');
                    const textInput = parent.querySelector('input[type="text"]');
                    const colorPreview = parent.querySelector('.color-preview');
                    
                    if (colorInput && textInput) {
                        colorInput.value = color;
                        textInput.value = color;
                        
                        if (colorPreview) {
                            colorPreview.style.backgroundColor = color;
                        }
                        
                        // Trigger change event to update preview
                        colorInput.dispatchEvent(new Event('input'));
                    }
                }
            });
        });
    }
    
    // Initialize card layout selection
    function initializeCardLayouts() {
        const layoutOptions = document.querySelectorAll('.layout-option');
        const layoutHidden = document.getElementById('layoutHidden');
        
        layoutOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove active class from all options
                layoutOptions.forEach(opt => {
                    opt.classList.remove('border-primary-500', 'active');
                });
                
                // Add active class to selected option
                this.classList.add('border-primary-500', 'active');
                
                // Update hidden input
                const layout = this.getAttribute('data-layout');
                layoutHidden.value = layout;
                
                // Update tag preview
                updateTagPreview();
            });
        });
        
        // Setup card flip functionality
        const rotateBtn = document.getElementById('rotate-preview');
        const cardFlipContainer = document.querySelector('.card-flip-container');
        
        rotateBtn.addEventListener('click', function() {
            cardFlipContainer.classList.toggle('flipped');
        });
    }
    
    // Initialize image upload
    function initializeImageUpload() {
        const dropzone = document.getElementById('dropzone');
        const imageInput = document.getElementById('product-image');
        const imagePreview = document.getElementById('image-preview');
        const previewImage = imagePreview.querySelector('img');
        const previewFilename = imagePreview.querySelector('.filename');
        const removeImageBtn = document.getElementById('remove-image');
        
        // Open file dialog when clicking on dropzone
        dropzone.addEventListener('click', function() {
            imageInput.click();
        });
        
        // Handle file selection
        imageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Check file type and size
                if (!file.type.match('image.*')) {
                    showNotification('Please select an image file', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showNotification('Image must be less than 5MB', 'error');
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewFilename.textContent = file.name;
                    imagePreview.classList.remove('hidden');
                    dropzone.classList.add('border-primary-400', 'border-opacity-20', 'bg-primary-50', 'bg-opacity-30');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Handle drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        // Highlight dropzone on drag over
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, function() {
                this.classList.add('border-primary-400', 'border-opacity-50', 'bg-primary-50');
            });
        });
        
        // Remove highlight on drag leave
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, function() {
                this.classList.remove('border-primary-400', 'border-opacity-50', 'bg-primary-50');
            });
        });
        
        // Handle file drop
        dropzone.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            
            if (files && files[0]) {
                const file = files[0];
                
                // Check file type and size
                if (!file.type.match('image.*')) {
                    showNotification('Please select an image file', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showNotification('Image must be less than 5MB', 'error');
                    return;
                }
                
                // Update file input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                imageInput.files = dataTransfer.files;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewFilename.textContent = file.name;
                    imagePreview.classList.remove('hidden');
                    dropzone.classList.add('border-primary-400', 'border-opacity-20', 'bg-primary-50', 'bg-opacity-30');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Remove image
        removeImageBtn.addEventListener('click', function() {
            imageInput.value = '';
            previewImage.src = '';
            previewFilename.textContent = '';
            imagePreview.classList.add('hidden');
            dropzone.classList.remove('border-primary-400', 'borpreview-400', 'border-opacity-20', 'bg-primary-50', 'bg-opacity-30');
        });
    }

    // Initialize Categories
    async function initializeCategories() {
        try {
            const response = await fetch('/api/Template/Categories');
            if (!response.ok) throw new Error('Failed to fetch categories');
            
            const categories = await response.json();
            
            // Update template tabs
            const templateTabs = document.querySelector('.template-tabs');
            const firstTab = templateTabs.querySelector('.template-tab'); // Keep the "All" tab
            
            // Remove existing category tabs (except the first "All" tab)
            Array.from(templateTabs.querySelectorAll('.template-tab:not(:first-child)')).forEach(tab => {
                tab.remove();
            });
            
            // Add category tabs
            categories.forEach(category => {
                const tabButton = document.createElement('button');
                tabButton.type = 'button';
                tabButton.className = 'template-tab whitespace-nowrap px-3 py-1.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                const categoryValue = category.toLowerCase().replace(/\s+/g, '-');
                tabButton.setAttribute('data-category', categoryValue);
                tabButton.textContent = category;
                templateTabs.appendChild(tabButton);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
            showNotification('Error loading categories', 'error');
        }
    }

    // Add new category
    async function addNewCategory(categoryName) {
        try {
            const token = document.querySelector('meta[name="RequestVerificationToken"]').content;
            const response = await fetch('/api/Template/Categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify(categoryName)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to add category');
            }
            
            // Reload categories
            await initializeCategories();
            
            // Update Category field if it exists
            const categoryField = document.getElementById('Category');
            if (categoryField) {
                categoryField.value = categoryName;
                updateFieldVisibility(categoryName);
            }
            
            showNotification(`Category "${categoryName}" added successfully`, 'success');
        } catch (error) {
            console.error('Error adding category:', error);
            showNotification('Error adding category: ' + error.message, 'error');
        }
    }

    // Get templates from API
    async function getTemplates() {
        try {
            const response = await fetch('/api/Template');
            if (!response.ok) {
                throw new Error('Failed to fetch templates');
            }
            return await response.json();
        } catch (error) {
            console.error('Error fetching templates:', error);
            showNotification('Error loading templates', 'error');
            return [];
        }
    }

    // Save template to API
    async function saveTemplate(template) {
        try {
            const token = document.querySelector('meta[name="RequestVerificationToken"]').content;
            const method = template.id > 0 ? 'PUT' : 'POST';
            const url = template.id > 0 ? `/api/Template/${template.id}` : '/api/Template';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify(template)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save template - Status: ${response.status}`);
            }
            
            // For successful POST responses, parse the JSON response
            if (method === 'POST' && response.status !== 204) {
                return await response.json();
            } else {
                return template; // For PUT, just return the original object
            }
        } catch (error) {
            console.error('Error saving template:', error);
            showNotification('Error saving template: ' + error.message, 'error');
            throw error;
        }
    }

    // Delete template from API
    async function deleteTemplate(templateId) {
        try {
            const token = document.querySelector('meta[name="RequestVerificationToken"]').content;
            const response = await fetch(`/api/Template/${templateId}`, {
                method: 'DELETE',
                headers: {
                    'RequestVerificationToken': token
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to delete template');
            }
            
            return true;
        } catch (error) {
            console.error('Error deleting template:', error);
            showNotification('Error deleting template: ' + error.message, 'error');
            return false;
        }
    }

    // Initialize templates
    async function initializeTemplates() {
        // Clear existing template containers
        const templateContainer = document.getElementById('template-container');
        const expandedContainer = document.getElementById('expanded-template-container');
        templateContainer.innerHTML = '';
        expandedContainer.innerHTML = '';
        
        // Load templates from API
        const templates = await getTemplates();
        
        // If templates were loaded, add them to containers
        if (templates && templates.length > 0) {
            // Sort templates by name
            templates.sort((a, b) => a.name.localeCompare(b.name));
            
            // Add first 6 templates to main container, rest to expanded container
            templates.forEach((template, index) => {
                if (index < 6) {
                    templateContainer.appendChild(createTemplateCard(template));
                } else {
                    expandedContainer.appendChild(createTemplateCard(template));
                }
            });
        }
        
        // Also add frequently used templates to recently used section
        const recentContainer = document.getElementById('recently-used-templates');
        recentContainer.innerHTML = '';
        
        // Get recently used templates (in a real app, this would be from user history)
        const recentTemplates = templates.slice(0, 3); // Just use the first 3 for demo
        
        recentTemplates.forEach(template => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'template-chip px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-primary-50 hover:text-primary-600 transition-colors';
            chip.setAttribute('data-template', template.id);
            
            chip.innerHTML = `<i class="fas fa-${template.icon} mr-1"></i> ${template.name}`;
            
            chip.addEventListener('click', () => applyTemplate(template.id));
            recentContainer.appendChild(chip);
        });
        
        // Template card click handler
        document.addEventListener('click', function(e) {
            const card = e.target.closest('.template-card');
            if (card && !e.target.closest('.edit-template-btn')) {
                const templateId = card.getAttribute('data-template');
                applyTemplate(templateId);
            }
        });
        
        // NOW initialize template tabs after templates are loaded
        initializeTemplateTabs();
    }

    // Apply template function
    async function applyTemplate(templateId) {
        document.getElementById('templateTypeHidden').value = templateId;
        console.log(`Applying template ID: ${templateId}`);
        
        try {
            const response = await fetch(`/api/Template/${templateId}`);
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            
            const template = await response.json();
            console.log('Template data loaded:', template);
            
            // Update UI for selected template
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('border-primary-500');
                if (card.getAttribute('data-template') === String(templateId)) {
                    card.classList.add('border-primary-500');
                }
            });
            
            // Auto-set the Category field from the template
            if (template.category) {
                const categoryField = document.getElementById('Category');
                if (categoryField) {
                    categoryField.value = template.category;
                }
            }
            
            // Get template fields container
            const templateFieldsContainer = document.getElementById('template-fields-container');
            
            // Display the template fields
            displayCustomTemplateFields(template, templateFieldsContainer);
            
            // Update field visibility based on the template's category
            if (template.category) {
                updateFieldVisibility(template.category);
            }
            
            // Update preview
            document.getElementById('preview-template-name').textContent = template.name || 'Template';
            document.getElementById('preview-template-icon').className = `fas fa-${template.icon || 'flask'}`;
            
            // Generate QR code
            setTimeout(generateQRCode, 100);
            
            // Update tag preview
            updateTagPreview();
            
            // Notify user
            showTemplateToast(template.name || 'Template');
        } catch (error) {
            console.error('Template application error:', error);
        }
    }

    // Create a template card element
    function createTemplateCard(template) {
        const card = document.createElement('div');
        card.className = 'template-card cursor-pointer border rounded-lg overflow-hidden hover:border-primary-500 hover:shadow transition-all relative group';
        card.setAttribute('data-template', template.id);
        card.setAttribute('data-category', template.category.toLowerCase().replace(/\s+/g, '-'));
        
        const bgColor = getBackgroundClass(template.bgColor);
        const iconColor = getColorClass(template.icon);
        
        card.innerHTML = `
            <div class="absolute top-1 right-1 flex template-actions opacity-0 group-hover:opacity-100 z-10">
                <button type="button" class="edit-template-btn p-1 text-gray-500 hover:text-primary-600 bg-white rounded-full shadow-sm" data-template="${template.id}">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            <div class="h-20 bg-${bgColor} flex items-center justify-center">
                <i class="fas fa-${template.icon} text-${iconColor} text-2xl"></i>
            </div>
            <div class="p-2 bg-white border-t border-gray-100">
                <h4 class="font-medium text-sm text-gray-800">${template.name}</h4>
                <p class="text-xs text-gray-500 mt-0.5">${template.category}</p>
            </div>
            <div class="absolute inset-0 bg-primary-500 bg-opacity-0 hover:bg-opacity-10 transition-all flex items-center justify-center">
                <span class="bg-white text-primary-600 px-2 py-1 rounded-full text-xs font-medium opacity-0 group-hover:opacity-100 transform scale-0 group-hover:scale-100 transition-all shadow-sm">
                    Select Template
                </span>
            </div>
        `;
        
        return card;
    }

    // Helper functions for template colors
    function getBackgroundClass(bgColor) {
        // Map hex colors to Tailwind classes
        const colorMap = {
            '#f0f9ff': 'blue-50',
            '#f0fdf4': 'green-50',
            '#fef3c7': 'yellow-50',
            '#fdf2f8': 'pink-50',
            '#faf5ff': 'purple-50'
        };
        
        return colorMap[bgColor] || 'gray-50'; // Default to gray-50
    }

    function getColorClass(icon) {
        // Map icons to appropriate color classes
        const iconMap = {
            'flask': 'blue-500',
            'vial': 'blue-500',
            'leaf': 'green-500',
            'seedling': 'green-500',
            'cogs': 'yellow-600',
            'tools': 'yellow-600',
            'wrench': 'yellow-600',
            'microchip': 'green-500',
            'laptop': 'green-500',
            'paint-brush': 'red-500',
            'palette': 'red-500',
            'shield-alt': 'orange-500',
            'hard-hat': 'orange-500'
        };
        
        return iconMap[icon] || 'primary-500'; // Default to primary-500
    }

    // Function to create template fields
    function createTemplateFields(template, container) {
        // Direct debug
        console.log('Creating fields for template:', template);
        
        let fields = [];
        try {
            if (template.fields && Array.isArray(template.fields)) {
                fields = template.fields;
            } else if (template.fieldsJson) {
                fields = JSON.parse(template.fieldsJson);
                console.log('Parsed fields:', fields);
            }
        } catch (error) {
            console.error('Error parsing fields:', error);
            return;
        }
        
        if (!fields || !fields.length) {
            console.log('No fields found in template');
            return;
        }
        
        // Create each field directly with HTML
        fields.forEach(field => {
            const fieldId = `custom-${field.name.replace(/\s+/g, '-').toLowerCase()}`;
            let fieldHtml = `
                <div class="form-group mb-4" data-field-name="${field.name}">
                    <label for="${fieldId}" class="form-label font-medium text-gray-700">
                        ${field.name}
                        ${field.required !== false ? '<span class="text-red-500 ml-1">*</span>' : ''}
                    </label>
                    <div class="relative">
            `;
            
            // Add appropriate input type
            if (field.type === 'textarea') {
                fieldHtml += `
                    <textarea id="${fieldId}" name="${fieldId}" class="form-input pl-9 h-20" 
                        placeholder="${field.placeholder || ''}" ${field.required !== false ? 'required' : ''}></textarea>
                        `;
        } else if (field.type === 'select') {
            fieldHtml += `
                <select id="${fieldId}" name="${fieldId}" class="form-input pl-9" ${field.required !== false ? 'required' : ''}>
            `;
            
            if (field.options && Array.isArray(field.options)) {
                field.options.forEach(option => {
                    fieldHtml += `<option value="${option}">${option}</option>`;
                });
            }
            
            fieldHtml += `</select>`;
        } else {
            fieldHtml += `
                <input type="${field.type || 'text'}" id="${fieldId}" name="${fieldId}" class="form-input pl-9" 
                    placeholder="${field.placeholder || ''}" ${field.required !== false ? 'required' : ''}>
            `;
        }
        
        // Add icon
        fieldHtml += `
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-${field.icon || 'tag'} text-gray-400"></i>
                    </div>
                </div>
            </div>
        `;
        
        // Append the HTML directly
        container.innerHTML += fieldHtml;
    });
    
    console.log('Fields created successfully');
}

// Display custom template fields
function displayCustomTemplateFields(template, container) {
    console.log('Raw template data:', template);
    container.innerHTML = '';
    
    let fields = [];
    
    // Direct fieldsJson access and parsing
    if (template.fieldsJson && typeof template.fieldsJson === 'string') {
        try {
            fields = JSON.parse(template.fieldsJson);
            console.log('Parsed fields from JSON string:', fields);
        } catch (e) {
            console.error('JSON parse error:', e);
        }
    } else if (template.fieldsJson && Array.isArray(template.fieldsJson)) {
        fields = template.fieldsJson;
        console.log('Using provided fields array:', fields);
    } else if (template.fields && Array.isArray(template.fields)) {
        fields = template.fields;
        console.log('Using template.fields array:', fields);
    }
    
    if (!fields || !fields.length) {
        console.warn('No fields found in template');
        container.innerHTML = '<div class="p-4 bg-gray-50 rounded-lg"><p class="text-gray-500">No custom fields available</p></div>';
        return;
    }
    
    // Force field rendering with direct HTML insertion
    fields.forEach(field => {
        const fieldId = `custom-${field.name.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}`;
        
        let html = `
            <div class="form-group mb-4" data-field-name="${field.name}">
                <label for="${fieldId}" class="form-label text-gray-700 font-medium">
                    ${field.name}
                    ${field.required !== false ? '<span class="text-red-500 ml-1">*</span>' : ''}
                </label>
                <div class="relative">`;
        
        if (field.type === 'textarea') {
            html += `<textarea id="${fieldId}" name="${fieldId}" class="form-input pl-9 h-20" ${field.required !== false ? 'required' : ''}
                     placeholder="${field.placeholder || ''}"></textarea>`;
        } else if (field.type === 'select') {
            html += `<select id="${fieldId}" name="${fieldId}" class="form-input pl-9" ${field.required !== false ? 'required' : ''}>`;
            if (field.options && Array.isArray(field.options)) {
                field.options.forEach(option => {
                    html += `<option value="${option}">${option}</option>`;
                });
            }
            html += `</select>`;
        } else {
            html += `<input type="${field.type || 'text'}" id="${fieldId}" name="${fieldId}" class="form-input pl-9"
                    ${field.required !== false ? 'required' : ''} placeholder="${field.placeholder || ''}">`;
        }
        
        html += `
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-${field.icon || 'tag'} text-gray-400"></i>
                    </div>
                </div>
            </div>`;
        
        container.innerHTML += html;
    });
    
    console.log(`Rendered ${fields.length} fields`);
}

// Show/hide fields based on category/template type
async function updateFieldVisibility(category) {
    // Check if category is a numeric template ID
    const isNumeric = !isNaN(parseInt(category));
    
    // Hide all custom fields first
    const fieldGroups = document.querySelectorAll('.field-group');
    fieldGroups.forEach(field => {
        field.style.display = 'none';
    });
    
    // Clear template fields container
    const templateFieldsContainer = document.getElementById('template-fields-container');
    
    // Don't clear fields if we're updating based on a category change
    if (!isNumeric) {
        templateFieldsContainer.innerHTML = '';
    }
    
    // Show fields based on category or template type
    if (isNumeric) {
        try {
            const response = await fetch(`/api/Template/${category}`);
            if (!response.ok) throw new Error('Failed to fetch template');
            const template = await response.json();
            
            // Only update fields if container is empty or we're switching templates
            if (templateFieldsContainer.children.length === 0) {
                displayCustomTemplateFields(template, templateFieldsContainer);
            }
            
            // Set the Category field from the template
            const categoryField = document.getElementById('Category');
            if (categoryField && template.category) {
                categoryField.value = template.category;
            }
        } catch (error) {
            console.error('Error fetching template:', error);
            generateDefaultFields(templateFieldsContainer);
        }
    } else {
        const categoryValue = category.toLowerCase();
        
        // Show/hide category-specific fields
        fieldGroups.forEach(field => {
            const fieldClass = field.classList[1]; // Get the second class which has the category name
            if (fieldClass && fieldClass.includes(categoryValue)) {
                field.style.display = 'block';
            }
        });
        
        // Set appropriate fields based on category
        switch(categoryValue) {
            case 'chemical':
            case 'rust coating chemical':
                document.querySelectorAll('.chemical-field').forEach(el => el.style.display = 'block');
                break;
            case 'design':
            case 'design asset':
                document.querySelectorAll('.design-field').forEach(el => el.style.display = 'block');
                // Change warranty to license for design assets
                document.querySelector('.warranty-label').innerHTML = 'License Expiration <span class="text-red-500 ml-1">*</span>';
                document.querySelector('.warranty-preview .font-medium').textContent = 'License Until:';
                break;
            default:
                // Reset warranty label for other types
                document.querySelector('.warranty-label').innerHTML = 'Warranty Until <span class="text-red-500 ml-1">*</span>';
                document.querySelector('.warranty-preview .font-medium').textContent = 'Warranty Until:';
                generateDefaultFields(templateFieldsContainer);
                break;
        }
    }
    
    // Update tag preview
    updateTagPreview();
}

// Generate default template fields
function generateDefaultFields(container) {
    container.innerHTML = `
        <div class="form-group">
            <label for="Manufacturer" class="form-label">
                Manufacturer
                <span class="text-red-500 ml-1">*</span>
            </label>
            <div class="relative">
                <input id="Manufacturer" name="Manufacturer" class="form-input pl-9" required placeholder="Manufacturer Name">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-industry text-gray-400"></i>
                </div>
            </div>
        </div>
    `;
}

// Update tag preview based on form values
function updateTagPreview() {
    const preview = document.getElementById('tag-preview');
    const previewName = document.getElementById('preview-name');
    const previewCategory = document.getElementById('preview-category');
    const previewManufacturer = document.getElementById('preview-manufacturer');
    const previewLocation = document.getElementById('preview-location');
    const previewMfgDate = document.getElementById('preview-mfgdate');
    const previewWarranty = document.getElementById('preview-warranty');
    const previewMaintenance = document.getElementById('preview-maintenance');
    const previewCustomFields = document.getElementById('preview-custom-fields');
    
    if (!preview || !previewName || !previewCategory) {
        console.error("Preview elements not found");
        return;
    }
    
    // Update colors
    const bgColor = document.getElementById('BackgroundColor')?.value || '#ffffff';
    const textColor = document.getElementById('TextColor')?.value || '#000000';
    const accentColor = document.getElementById('AccentColor')?.value || '#0284c7';
    
    preview.style.backgroundColor = bgColor;
    preview.style.color = textColor;
    previewName.style.color = accentColor;
    previewCategory.style.backgroundColor = accentColor;
    
    document.querySelectorAll('#tag-preview i').forEach(icon => {
        icon.style.color = accentColor;
    });
    
    // Update back of card background
    const cardBack = document.querySelector('.card-back');
    if (cardBack) {
        cardBack.style.backgroundColor = bgColor;
    }
    
    // Update content
    const productName = document.getElementById('ProductName');
    if (productName && productName.value) {
        previewName.textContent = productName.value;
        
        // Update QR product name
        const qrProductName = document.getElementById('qr-product-name');
        if (qrProductName) {
            qrProductName.textContent = productName.value;
        }
    } else {
        previewName.textContent = "Product Name";
    }
    
    const category = document.getElementById('Category');
    if (category && category.value) {
        previewCategory.textContent = category.value;
    } else {
        previewCategory.textContent = "Category";
    }
    
    const manufacturer = document.getElementById('Manufacturer');
    if (manufacturer && manufacturer.value) {
        previewManufacturer.textContent = manufacturer.value;
    } else {
        previewManufacturer.textContent = "Manufacturer";
    }
    
    const location = document.getElementById('Location');
    if (location && location.value) {
        previewLocation.textContent = location.value;
    } else {
        previewLocation.textContent = "Not specified";
    }
    
    const mfgDate = document.getElementById('ManufactureDate');
    if (mfgDate && mfgDate.value) {
        previewMfgDate.textContent = new Date(mfgDate.value).toLocaleDateString();
    }
    
    const warranty = document.getElementById('WarrantyExpiration');
    if (warranty && warranty.value) {
        previewWarranty.textContent = new Date(warranty.value).toLocaleDateString();
    }
    
    const maintenance = document.getElementById('MaintenanceInfo');
    if (maintenance && maintenance.value) {
        previewMaintenance.textContent = maintenance.value.length > 40 ? 
            maintenance.value.substring(0, 40) + '...' : 
            maintenance.value;
    } else {
        previewMaintenance.textContent = "No maintenance info";
    }
    
    // Update custom fields
    if (previewCustomFields) {
        previewCustomFields.innerHTML = '';
        
        document.querySelectorAll('[id^="custom-"]').forEach(field => {
            if (field.value) {
                const fieldName = field.id.replace('custom-', '').replace(/-/g, ' ');
                const fieldElement = document.createElement('div');
                fieldElement.className = 'flex items-center space-x-2 text-sm mt-1';
                fieldElement.innerHTML = `
                    <span class="font-semibold">${fieldName}:</span>&nbsp;<span>${field.value}</span>
                `;
                
                previewCustomFields.appendChild(fieldElement);
            }
        });
    }
    
    // Update layout
    const layout = document.getElementById('layoutHidden')?.value || 'standard';
    preview.className = 'business-card card-side card-front';
    
    switch (layout) {
        case 'modern':
            preview.classList.add('modern-layout');
            break;
        case 'compact':
            preview.classList.add('compact-layout');
            break;
        default:
            preview.classList.add('standard-layout');
            break;
    }
}

// Initialize template modal
function initializeTemplateModal() {
    const createBtn = document.getElementById('create-template-btn');
    const modal = document.getElementById('create-template-modal');
    const closeBtn = document.getElementById('close-template-modal');
    const cancelBtn = document.getElementById('cancel-template-btn');
    const saveBtn = document.getElementById('save-template-btn');
    const deleteBtn = document.getElementById('delete-template-btn');
    const addFieldBtn = document.getElementById('add-field-btn');
    const customFields = document.getElementById('custom-fields');
    const deleteModal = document.getElementById('delete-template-modal');
    const closeDeleteBtn = document.getElementById('close-delete-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    
    // Open template modal
    createBtn.addEventListener('click', () => openTemplateModal('create'));
    
    // Handle edit template button clicks
    document.addEventListener('click', e => {
        const btn = e.target.closest('.edit-template-btn');
        if (btn) {
            const templateId = btn.getAttribute('data-template');
            openTemplateModal('edit', templateId);
        }
    });
    
    // Open template modal function
    async function openTemplateModal(mode, templateId = null) {
        // Set modal title based on mode
        document.getElementById('template-modal-title').textContent = mode === 'create' ? 'Create New Template' : 'Edit Template';
        
        // Show/hide delete button
        deleteBtn.classList.toggle('hidden', mode === 'create');
        
        // Reset form
        document.getElementById('template-form').reset();
        document.getElementById('template-edit-id').value = '';
        
        // Clear custom fields except the first one
        const fieldRows = customFields.querySelectorAll('.custom-field-row');
        if (fieldRows.length > 1) {
            for (let i = 1; i < fieldRows.length; i++) {
                fieldRows[i].remove();
            }
        }
        
        // Reset first field row
        const firstRow = customFields.querySelector('.custom-field-row');
        if (firstRow) {
            firstRow.querySelector('.field-name').value = '';
            firstRow.querySelector('.field-type').value = 'text';
            firstRow.querySelector('.field-icon').value = 'tag';
            firstRow.querySelector('.field-placeholder').value = '';
            firstRow.querySelector('.field-options').classList.add('hidden');
            
            if (firstRow.querySelector('.field-options-input')) {
                firstRow.querySelector('.field-options-input').value = '';
            }
            
            if (firstRow.querySelector('.field-required')) {
                firstRow.querySelector('.field-required').checked = true;
            }
        }
        
        // Reset icon selection
        document.querySelectorAll('.icon-option').forEach(opt => {
            opt.classList.remove('border-primary-500', 'active');
            opt.querySelector('i').classList.remove('text-primary-500');
            opt.querySelector('i').classList.add('text-gray-500');
        });
        
        document.querySelector('.icon-option[data-icon="flask"]').classList.add('border-primary-500', 'active');
        document.querySelector('.icon-option[data-icon="flask"] i').classList.remove('text-gray-500');
        document.querySelector('.icon-option[data-icon="flask"] i').classList.add('text-primary-500');
        document.getElementById('template-icon').value = 'flask';
        
        // If editing, populate form with template data
        if (mode === 'edit' && templateId) {
            await populateTemplateForm(templateId);
        }
        
        // Show modal
        modal.classList.remove('hidden');
        
        // Animate modal
        setTimeout(() => {
            modal.querySelector('.bg-white').classList.remove('opacity-0', 'scale-95');
            modal.querySelector('.bg-white').classList.add('opacity-100', 'scale-100');
        }, 10);
    }
    
    // Populate template form with data
    async function populateTemplateForm(templateId) {
        try {
            const response = await fetch(`/api/Template/${templateId}`);
            if (!response.ok) throw new Error('Failed to fetch template');
            
            const template = await response.json();
            
            // Set template ID and delete ID
            document.getElementById('template-edit-id').value = template.id;
            document.getElementById('delete-template-id').value = template.id;
            
            // Populate basic fields
            document.getElementById('template-name').value = template.name || '';
            document.getElementById('template-category').value = template.category || '';
            document.getElementById('template-bg-color').value = template.bgColor || '#f0f9ff';
            document.getElementById('template-bg-color-text').value = template.bgColor || '#f0f9ff';
            
            // Select icon
            const iconElement = document.querySelector(`.icon-option[data-icon="${template.icon}"]`);
            if (iconElement) {
                document.querySelectorAll('.icon-option').forEach(opt => {
                    opt.classList.remove('border-primary-500', 'active');
                    opt.querySelector('i').classList.remove('text-primary-500');
                    opt.querySelector('i').classList.add('text-gray-500');
                });
                
                iconElement.classList.add('border-primary-500', 'active');
                iconElement.querySelector('i').classList.remove('text-gray-500');
                iconElement.querySelector('i').classList.add('text-primary-500');
                document.getElementById('template-icon').value = template.icon;
            }
            
            // Parse fields
            let fields = [];
            try {
                if (template.fieldsJson) {
                    fields = JSON.parse(template.fieldsJson);
                }
            } catch (e) {
                console.error('Error parsing fields JSON:', e);
            }
            
            // Clear existing fields
            customFields.innerHTML = '';
            
            // Add field rows
            if (fields && fields.length > 0) {
                fields.forEach(field => addCustomField(field));
            } else {
                addCustomField(); // Add an empty field
            }
        } catch (error) {
            console.error('Error populating template form:', error);
            showNotification('Error loading template', 'error');
        }
    }
    
    // Add custom field row
    function addCustomField(fieldData = null) {
        const newField = document.createElement('div');
        newField.className = 'custom-field-row flex items-start gap-2 p-3 border border-gray-100 rounded-lg bg-gray-50 hover:bg-white hover:shadow-sm transition-all';
        
        const fieldId = Date.now();
        
        newField.innerHTML = `
            <div class="flex-grow">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="form-group mb-2">
                        <label class="form-label text-sm">Field Name <span class="text-red-500">*</span></label>
                        <input type="text" class="form-input py-2 text-sm field-name" placeholder="E.g., Lab ID" required>
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label text-sm">Field Type <span class="text-red-500">*</span></label>
                        <select class="form-input py-2 text-sm field-type">
                            <option value="text">Text</option>
                            <option value="select">Dropdown</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="textarea">Text Area</option>
                        </select>
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label text-sm">Icon</label>
                        <select class="form-input py-2 text-sm field-icon">
                            <option value="tag">Tag</option>
                            <option value="info-circle">Info</option>
                            <option value="check-circle">Check</option>
                            <option value="flag">Flag</option>
                            <option value="clipboard">Clipboard</option>
                            <option value="calendar">Calendar</option>
                            <option value="user">User</option>
                            <option value="link">Link</option>
                        </select>
                    </div>
                </div>
                <div class="field-options hidden mt-2">
                    <label class="form-label text-sm">Options (comma separated)</label>
                    <input type="text" class="form-input py-2 text-sm field-options-input" placeholder="Option 1, Option 2, Option 3">
                </div>
                <div class="form-group mt-2">
                    <label class="form-label text-sm">Placeholder</label>
                    <input type="text" class="form-input py-2 text-sm field-placeholder" placeholder="Enter placeholder text">
                </div>
                <div class="form-group mt-2">
                    <div class="flex items-center">
                        <input type="checkbox" class="field-required mr-2" id="field-required-checkbox-${fieldId}" checked>
                        <label for="field-required-checkbox-${fieldId}" class="text-sm">Required</label>
                    </div>
                </div>
            </div>
            <div class="flex-shrink-0 mt-6">
                <button type="button" class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full transition-colors remove-field-btn">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        customFields.appendChild(newField);
        
        // Add event listener for field type change
        const fieldTypeSelect = newField.querySelector('.field-type');
        fieldTypeSelect.addEventListener('change', function() {
            const optionsDiv = newField.querySelector('.field-options');
            optionsDiv.classList.toggle('hidden', this.value !== 'select');
        });
        
        // If field data provided, populate the field
        if (fieldData) {
            const nameInput = newField.querySelector('.field-name');
            const typeSelect = newField.querySelector('.field-type');
            const iconSelect = newField.querySelector('.field-icon');
            const placeholderInput = newField.querySelector('.field-placeholder');
            const requiredCheckbox = newField.querySelector('.field-required');
            const optionsDiv = newField.querySelector('.field-options');
            const optionsInput = newField.querySelector('.field-options-input');
            
            nameInput.value = fieldData.name || '';
            typeSelect.value = fieldData.type || 'text';
            iconSelect.value = fieldData.icon || 'tag';
            placeholderInput.value = fieldData.placeholder || '';
            
            if (requiredCheckbox) {
                requiredCheckbox.checked = fieldData.required !== false;
            }
            
            if (fieldData.type === 'select') {
                optionsDiv.classList.remove('hidden');
                
                if (optionsInput && fieldData.options && Array.isArray(fieldData.options)) {
                    optionsInput.value = fieldData.options.join(', ');
                }
            }
        }
    }
    
    // Close modal functions
    function closeModal() {
        modal.querySelector('.bg-white').classList.remove('opacity-100', 'scale-100');
        modal.querySelector('.bg-white').classList.add('opacity-0', 'scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
    
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    
    // Close delete modal
    function closeDeleteModal() {
        deleteModal.querySelector('.bg-white').classList.remove('opacity-100', 'scale-100');
        deleteModal.querySelector('.bg-white').classList.add('opacity-0', 'scale-95');
        
        setTimeout(() => {
            deleteModal.classList.add('hidden');
        }, 300);
    }
    
    closeDeleteBtn.addEventListener('click', closeDeleteModal);
    cancelDeleteBtn.addEventListener('click', closeDeleteModal);
    
    // Icon selection
    document.querySelectorAll('.icon-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove active class from all options
            document.querySelectorAll('.icon-option').forEach(opt => {
                opt.classList.remove('border-primary-500', 'active');
                opt.querySelector('i').classList.remove('text-primary-500');
                opt.querySelector('i').classList.add('text-gray-500');
            });
            
            // Add active class to this option
            this.classList.add('border-primary-500', 'active');
            this.querySelector('i').classList.remove('text-gray-500');
            this.querySelector('i').classList.add('text-primary-500');
            
            // Update hidden input
            document.getElementById('template-icon').value = this.getAttribute('data-icon');
        });
    });
    
    // Connect color inputs
    const templateBgColor = document.getElementById('template-bg-color');
    const templateBgColorText = document.getElementById('template-bg-color-text');
    
    templateBgColor.addEventListener('input', function() {
        templateBgColorText.value = this.value;
    });
    
    templateBgColorText.addEventListener('input', function() {
        templateBgColor.value = this.value;
    });
    
    // Add field button
    addFieldBtn.addEventListener('click', () => addCustomField());
    
    // Remove field button
    customFields.addEventListener('click', function(e) {
        const btn = e.target.closest('.remove-field-btn');
        if (btn) {
            const fieldRow = btn.closest('.custom-field-row');
            
            // Don't remove if it's the last field
            if (customFields.querySelectorAll('.custom-field-row').length > 1) {
                fieldRow.remove();
            } else {
                showNotification('You must have at least one custom field', 'error');
            }
        }
    });
    
    // Delete template button
    deleteBtn.addEventListener('click', function() {
        const templateId = document.getElementById('template-edit-id').value;
        const templateName = document.getElementById('template-name').value;
        
        if (!templateId) return;
        
        // Update confirmation modal
        document.getElementById('delete-template-name').textContent = templateName;
        document.getElementById('delete-template-id').value = templateId;
        
        // Hide template modal
        closeModal();
        
        // Show delete confirmation modal
        deleteModal.classList.remove('hidden');
        
        setTimeout(() => {
            deleteModal.querySelector('.bg-white').classList.remove('opacity-0', 'scale-95');
            deleteModal.querySelector('.bg-white').classList.add('opacity-100', 'scale-100');
        }, 10);
    });
    
    // Confirm delete
    confirmDeleteBtn.addEventListener('click', async function() {
        const templateId = document.getElementById('delete-template-id').value;
        
        if (!templateId) return;
        
        // Delete template from API
        const success = await deleteTemplate(templateId);
        
        if (success) {
            // Get template name for notification
            const templateName = document.getElementById('delete-template-name').textContent;
            
            // Remove template card from UI
            const templateCard = document.querySelector(`.template-card[data-template="${templateId}"]`);
            if (templateCard) {
                templateCard.remove();
            }
            
            // Close modal
            closeDeleteModal();
            
            // Refresh template list
            initializeTemplates();
            
            // Show success notification
            showNotification(`Template "${templateName}" deleted successfully`, 'success');
        }
    });
    
    // Save template
    saveBtn.addEventListener('click', async function() {
        // Validate form
        const form = document.getElementById('template-form');
        const requiredInputs = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredInputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('border-red-500');
                isValid = false;
            } else {
                input.classList.remove('border-red-500');
            }
        });
        
        if (!isValid) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }
        
        // Collect template data
        const templateId = document.getElementById('template-edit-id').value;
        const templateName = document.getElementById('template-name').value;
        const templateCategory = document.getElementById('template-category').value;
        const templateIcon = document.getElementById('template-icon').value;
        const templateBgColor = document.getElementById('template-bg-color').value;
        
        // Collect fields data
        const fields = [];
        const fieldRows = document.querySelectorAll('.custom-field-row');
        
        fieldRows.forEach(row => {
            const fieldName = row.querySelector('.field-name').value;
            const fieldType = row.querySelector('.field-type').value;
            const fieldIcon = row.querySelector('.field-icon').value;
            const fieldPlaceholder = row.querySelector('.field-placeholder').value;
            const fieldRequired = row.querySelector('.field-required')?.checked ?? true;
            
            let options = [];
            if (fieldType === 'select') {
                const optionsInput = row.querySelector('.field-options-input');
                if (optionsInput && optionsInput.value) {
                    options = optionsInput.value.split(',').map(opt => opt.trim());
                }
            }
            
            fields.push({
                name: fieldName,
                type: fieldType,
                icon: fieldIcon,
                placeholder: fieldPlaceholder,
                options: options,
                required: fieldRequired
            });
        });
        
        // Create template object
        const template = {
            id: templateId ? parseInt(templateId) : 0,
            name: templateName,
            category: templateCategory,
            icon: templateIcon,
            bgColor: templateBgColor,
            fieldsJson: JSON.stringify(fields)
        };
        
        try {
            // Save template
            const savedTemplate = await saveTemplate(template);
            
            // Close modal
            closeModal();
            
            // Refresh templates
            await initializeTemplates();
            
            // Show success notification
            showNotification(`Template "${templateName}" ${templateId ? 'updated' : 'created'} successfully`, 'success');
        } catch (error) {
            showNotification('Error saving template: ' + error.message, 'error');
        }
    });
}

// Add category button click handler
document.getElementById('add-category-btn').addEventListener('click', function() {
    const modal = document.getElementById('add-category-modal');
    modal.classList.remove('hidden');
    
    // Animate modal
    setTimeout(() => {
        modal.querySelector('.bg-white').classList.remove('opacity-0', 'scale-95');
        modal.querySelector('.bg-white').classList.add('opacity-100', 'scale-100');
        
        // Focus the input
        document.getElementById('new-category-name').focus();
    }, 10);
});

// Close modal function
function closeCategoryModal() {
    const modal = document.getElementById('add-category-modal');
    modal.querySelector('.bg-white').classList.remove('opacity-100', 'scale-100');
    modal.querySelector('.bg-white').classList.add('opacity-0', 'scale-95');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        document.getElementById('new-category-name').value = '';
    }, 300);
}

// Close and cancel button handlers
document.getElementById('close-category-modal').addEventListener('click', closeCategoryModal);
document.getElementById('cancel-category-btn').addEventListener('click', closeCategoryModal);

// Save category button handler
document.getElementById('save-category-btn').addEventListener('click', function() {
    const categoryName = document.getElementById('new-category-name').value.trim();
    
    if (!categoryName) {
        document.getElementById('new-category-name').classList.add('border-red-500');
        return;
    }
    
    closeCategoryModal();
    addNewCategory(categoryName);
});

// Notification system
window.showNotification = function(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 bg-white shadow-lg rounded-lg p-4 transform translate-y-0 opacity-0 transition-all duration-300 z-50 max-w-sm border border-gray-100';
    
    let iconClass, iconColor, bgColor;
    if (type === 'success') {
        iconClass = 'fas fa-check';
        iconColor = 'text-green-500';
        bgColor = 'bg-green-100';
    } else if (type === 'error') {
        iconClass = 'fas fa-times';
        iconColor = 'text-red-500';
        bgColor = 'bg-red-100';
    } else if (type === 'info') {
        iconClass = 'fas fa-info';
        iconColor = 'text-blue-500';
        bgColor = 'bg-blue-100';
    }
    
    toast.innerHTML = `
        <div class="flex items-center">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full ${bgColor} ${iconColor} mr-3">
                <i class="${iconClass}"></i>
            </div>
            <div class="flex-grow">
                <p class="font-medium">${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                <p class="text-sm text-gray-500">${message}</p>
            </div>
            <button onclick="this.parentNode.parentNode.remove()" class="ml-2 text-gray-400 hover:text-gray-600 h-8 w-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.replace('opacity-0', 'opacity-100');
        toast.classList.replace('translate-y-0', 'translate-y-[-20px]');
    }, 10);
    
    // Automatically remove after 3 seconds
    setTimeout(() => {
        toast.classList.replace('opacity-100', 'opacity-0');
        toast.classList.replace('translate-y-[-20px]', 'translate-y-20');
        
        // Remove from DOM after animation
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
};
});
</script>
}